<!doctype html>
<html lang="id">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Aplikasi Input Nilai ‚Äî Firestore (Mobile Friendly)</title>
<style>
/* =========================
   ROOT THEME
========================= */
:root {
  --bg: #f8fafc;
  --card: #ffffff;

  --primary: #06b6d4;
  --primary-dark: #0284c7;
  --primary-soft: #e0f7ff;

  --danger: #ef4444;
  --danger-dark: #dc2626;

  --muted: #64748b;

  --radius: 16px;
  --radius-sm: 10px;

  --shadow-sm: 0 2px 6px rgba(0,0,0,.06);
  --shadow-md: 0 8px 24px rgba(0,0,0,.08);
}

/* =========================
   GLOBAL RESET
========================= */
* {
  box-sizing: border-box;
  font-family: Inter, ui-sans-serif, system-ui, -apple-system,
    "Segoe UI", Roboto, "Helvetica Neue", Arial;
  transition: background-color .2s ease,
              color .2s ease,
              box-shadow .2s ease,
              transform .2s ease;
}

body {
  margin: 0;
  background: linear-gradient(180deg,#f0f4f8,#ffffff);
  color: #222;
  font-size: 15px;
}

h1 {
  margin: 0;
  font-size: 20px;
  font-weight: 800;
  background: linear-gradient(135deg,var(--primary-dark),var(--primary));
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
}

.container {
  max-width: 1100px;
  margin: 0 auto;
  padding: 0 16px;
}

/* =========================
   HEADER
========================= */
header {
  display:flex;
  justify-content:space-between;
  align-items:center;
  margin-bottom:16px;
  flex-wrap:wrap;
  gap:8px;
}

.auth-area {
  display:flex;
  gap:8px;
  align-items:center;
  flex-wrap:wrap;
  justify-content:flex-end;
}

/* =========================
   CARD & PANEL (SOFT BORDER)
========================= */
.card,
.panel {
  background: var(--card);
  border-radius: var(--radius);
  padding: 16px;
  border:1px solid rgba(0,0,0,.06);
  box-shadow:
    0 1px 2px rgba(0,0,0,.04),
    0 8px 24px rgba(0,0,0,.06);
}

.panel {
  background: linear-gradient(180deg,#ffffff,#f8fafc);
}

.panel:hover {
  transform: translateY(-2px);
  box-shadow: var(--shadow-md);
}

/* =========================
   TABS (SMOOTH & ELEGANT)
========================= */
.tabs {
  display:flex;
  gap:6px;
  padding:6px;
  background:linear-gradient(180deg,#e0f2fe,#f0f9ff);
  border-radius:16px;
  border:1px solid rgba(6,182,212,.25);
  box-shadow: inset 0 1px 2px rgba(255,255,255,.6);
  overflow-x:auto;
  margin-bottom:12px;
}

.tab {
  padding:8px 16px;
  border-radius:14px;
  cursor:pointer;
  font-weight:600;
  color:var(--primary-dark);
  background:rgba(255,255,255,.6);
  border:1px solid rgba(6,182,212,.15);
  white-space:nowrap;
  backdrop-filter: blur(4px);
transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}

.tab:hover {
  background:var(--primary-soft);
  border-color:rgba(6,182,212,.35);
}

.tab.active {
  background:linear-gradient(135deg,var(--primary),var(--primary-dark));
  color:#fff;
  border-color:transparent;
  box-shadow:0 6px 16px rgba(6,182,212,.45);
transform: scale(1.05); /* Sedikit membesar saat aktif agar terasa interaktif */
}

/* =========================
   GRID
========================= */
.grid {
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:16px;
  justify-items:center;
}

/* =========================
   FORM
========================= */
label {
  display:block;
  font-size:13px;
  color:var(--muted);
  margin-bottom:6px;
}

input[type=text],
input[type=number],
select {
  width:100%;
  padding:10px;
  border-radius:var(--radius-sm);
  border:1px solid #ccc;
}

input:focus,
select:focus {
  outline:none;
  border-color:var(--primary);
  box-shadow:0 0 0 3px rgba(6,182,212,.25);
}

/* =========================
   BUTTON SYSTEM
========================= */
.btn {
  display:inline-flex;
  align-items:center;
  justify-content:center;
  padding:10px 16px;
  border-radius:var(--radius-sm);
  border:none;
  cursor:pointer;
  font-weight:600;
  color:#fff;
  background:linear-gradient(135deg,var(--primary),var(--primary-dark));
  box-shadow:0 4px 12px rgba(6,182,212,.35);
}

.btn:hover {
  transform:translateY(-1px);
  box-shadow:0 6px 16px rgba(6,182,212,.45);
}

.btn.small {
  padding:6px 12px;
  font-size:13px;
}

/* EDIT */
.btn.edit,
.btnEdit,
.btnEditTx {
  background:linear-gradient(135deg,var(--primary),var(--primary-dark));
  border:1px solid var(--primary-dark);
}

/* DELETE NORMAL */
.btn.delete,
.btnDel,
.btnDelTx {
  background:linear-gradient(135deg,var(--danger),var(--danger-dark));
  border:1px solid var(--danger-dark);
  box-shadow:0 3px 10px rgba(239,68,68,.35);
}

/* DELETE ALL (SUPER RED) */
.btn.delete-all,
.btn.hapus-semua {
  background: linear-gradient(135deg,#ff4d4f,#dc2626);
  border: 1px solid #b91c1c;
  box-shadow:0 6px 18px rgba(239,68,68,.45);
}

.btn.delete-all:hover,
.btn.hapus-semua:hover {
  background: linear-gradient(135deg,#dc2626,#b91c1c);
  transform:translateY(-1px) scale(1.02);
  box-shadow:0 8px 24px rgba(239,68,68,.55);
}

/* GHOST */
.btn.ghost {
  background:#f1f5f9;
  color:var(--muted);
  box-shadow:none;
  border:1px solid #cbd5e1;
}

.btn.ghost:hover {
  background:var(--primary);
  color:#fff;
  border-color:var(--primary-dark);
}

/* =========================
   SANTRI LIST
========================= */
.santri-list {
  max-height:380px;
  overflow:auto;
  margin-top:10px;
  padding:8px;
  border-radius:12px;
  border:1px dashed rgba(0,0,0,.1);
  background:#fafafa;
}

.santri-row {
  display:flex;
  gap:12px;
  align-items:center;
  padding:8px;
  border-radius:10px;
}

.santri-row:nth-child(odd) {
  background:rgba(0,0,0,.02);
}

.santri-row:hover {
  background:var(--primary-soft);
}

/* =========================
   TABLE (SMOOTH & MODERN)
========================= */
.transactions {
  margin-top:12px;
  overflow-x:auto;
  border-radius:14px;
  border:1px solid rgba(0,0,0,.06);
  box-shadow: var(--shadow-sm);
}

table {
  width:100%;
  border-collapse:separate;
  border-spacing:0;
  border-radius:14px;
  overflow:hidden;
}

th, td {
  padding:10px 12px;
  font-size:13px;
  border-bottom:1px solid rgba(0,0,0,.05);
}

th {
  background:linear-gradient(180deg,#f8fafc,#f1f5f9);
  color:var(--muted);
  font-weight:700;
}

tbody tr:last-child td {
  border-bottom:none;
}

tbody tr:hover {
  background:rgba(6,182,212,.08);
}

/* =========================
   RESPONSIVE
========================= */
@media(max-width:900px){
  .grid {
    grid-template-columns:1fr;
  }
  .panel {
    width:100%;
  }
}

@media(max-width:600px){
  body { font-size:14px; padding:12px; }
  h1 { font-size:18px; }

  table, thead, tbody, th, td, tr {
    display:block;
    width:100%;
  }

  thead { display:none; }

  tr {
    margin-bottom:10px;
    border-bottom:1px solid rgba(0,0,0,.1);
  }

  td {
    display:flex;
    justify-content:space-between;
    padding:6px 8px;
  }

  td::before {
    content:attr(data-label);
    font-weight:600;
    color:var(--muted);
  }
}

button:disabled {
  opacity:.5;
  cursor:not-allowed;
}
.table-responsive {
  display: block;
  width: 100%;
  overflow-x: auto;
  -webkit-overflow-scrolling: touch;
}
.badge {
  background: var(--primary-soft);
  color: var(--primary-dark);
  padding: 2px 8px;
  border-radius: 8px;
  font-size: 11px;
  font-weight: 600;
  text-transform: uppercase;
}
input[type="number"] {
  font-size: 16px; /* Mencegah auto-zoom di iOS Safari */
  -moz-appearance: textfield;
}
input::-webkit-outer-spin-button,
input::-webkit-inner-spin-button {
  -webkit-appearance: none;
  margin: 0;
}
.btn.edit {
  background: linear-gradient(135deg, #f59e0b, #d97706); /* Warna Oranye/Amber */
  border: 1px solid #b45309;
  box-shadow: 0 3px 10px rgba(245, 158, 11, 0.3);
  margin-right: 4px; /* Memberi jarak dengan tombol hapus */
}

.btn.edit:hover {
  background: linear-gradient(135deg, #d97706, #b45309);
  transform: translateY(-1px);
}
/* Animasi konten masuk */
@keyframes fadeIn {
  from { 
    opacity: 0; 
    transform: translateY(10px); 
  }
  to { 
    opacity: 1; 
    transform: translateY(0); 
  }
}

#mainPanel {
  animation: fadeIn 0.4s ease-out;
  /* Memastikan transisi smooth saat tinggi panel berubah */
  transition: all 0.3s ease;
}
/* Efek saat tombol ditekan */
.btn:active, .tab:active {
  transform: scale(0.95);
  filter: brightness(0.9);
}

/* Membuat scrollbar di tab mobile lebih halus */
.tabs {
  scroll-behavior: smooth;
  -webkit-overflow-scrolling: touch;
}

/* Menghilangkan scrollbar tapi tetap bisa di-scroll (opsional agar bersih) */
.tabs::-webkit-scrollbar {
  display: none;
}
.tabs {
  -ms-overflow-style: none;  /* IE and Edge */
  scrollbar-width: none;  /* Firefox */
}
/* Animasi Putar */
@keyframes spin {
  to { transform: rotate(360deg); }
}

.spinner {
  width: 18px;
  height: 18px;
  border: 3px solid rgba(255,255,255,0.3);
  border-radius: 50%;
  border-top-color: #fff;
  animation: spin 0.8s linear infinite;
  margin-right: 10px;
  display: inline-block;
  vertical-align: middle;
}

/* State tombol saat loading */
.btn-loading {
  pointer-events: none; /* Mencegah klik ganda */
  opacity: 0.8;
}
.badge-uh { background: #dcfce7; color: #166534; }
.badge-pts { background: #fef9c3; color: #854d0e; }
.badge-pas { background: #dbeafe; color: #1e40af; }
.input-score.error {
  border: 2px solid var(--danger) !important;
  background-color: #fff1f2;
}
/* Secara default tetap tampil */
.tab { display: block; }

/* Sembunyikan Tab Khusus Admin */
body.role-user .tab[data-tab="DAFTAR_SANTRI"],
body.role-user .tab[data-tab="DAFTAR_MAPEL"],
body.role-user .tab[data-tab="DAFTAR_GURU"],
body.role-user .tab[data-tab="REKAP_SISWA"] {
  display: none;
}

/* Sembunyikan Panel Kanan (Tabel Transaksi) untuk User */
body.role-user .grid {
  grid-template-columns: 1fr; /* Ubah grid menjadi 1 kolom penuh */
}

body.role-user .grid > .panel:nth-child(2) {
  display: none; /* Sembunyikan panel kedua (tabel transaksi) */
}
/* =========================
   TOAST NOTIFICATION
========================= */
#toast-container {
  position: fixed;
  top: 20px;
  right: 20px;
  z-index: 10000;
}

.toast {
  display: flex;
  align-items: center;
  min-width: 280px;
  padding: 16px;
  margin-bottom: 12px;
  border-radius: 12px;
  background: #ffffff;
  color: #333;
  box-shadow: 0 10px 25px rgba(0,0,0,0.1);
  border-left: 6px solid var(--primary);
  transform: translateX(120%);
  transition: transform 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
}

.toast.show {
  transform: translateX(0);
}

.toast-icon {
  margin-right: 12px;
  font-size: 20px;
  background: var(--primary-soft);
  color: var(--primary-dark);
  width: 32px;
  height: 32px;
  display: flex;
  align-items: center;
  justify-content: center;
  border-radius: 50%;
}

.toast-content {
  flex: 1;
}

.toast-title {
  font-weight: 700;
  font-size: 14px;
  display: block;
}

.toast-msg {
  font-size: 13px;
  color: var(--muted);
}

/* Variasi Sukses */
.toast.success { border-left-color: #22c55e; }
.toast.success .toast-icon { background: #dcfce7; color: #166534; }
/* =========================
   SUMMARY MODAL & STATS
========================= */
.summary-card {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 12px;
  margin-bottom: 20px;
}
.stat-box {
  padding: 12px;
  border-radius: 12px;
  text-align: center;
}
.stat-box.success { background: #dcfce7; color: #166534; }
.stat-box.danger { background: #fee2e2; color: #991b1b; }

.remedial-list {
  max-height: 200px;
  overflow-y: auto;
  border: 1px solid #eee;
  border-radius: 10px;
  padding: 10px;
}
.remedial-item {
  display: flex;
  justify-content: space-between;
  padding: 6px 0;
  border-bottom: 1px dashed #eee;
  font-size: 13px;
}
/* =========================
   CUSTOM SELECT STYLING
========================= */
select {
  appearance: none; /* Menghilangkan panah default browser */
  -webkit-appearance: none;
  -moz-appearance: none;
  
  background-color: #ffffff;
  background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='%2364748b'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d=' immigration 19 9l-7 7-7-7'%3E%3C/path%3E%3C/svg%3E");
  background-repeat: no-repeat;
  background-position: right 12px center;
  background-size: 16px;
  
  padding: 12px 40px 12px 12px;
  font-size: 14px;
  color: #1e293b;
  border: 1px solid #e2e8f0;
  border-radius: var(--radius-sm);
  cursor: pointer;
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
}

/* Efek saat Select di-Klik/Fokus */
select:focus {
  outline: none;
  border-color: var(--primary);
  background-color: #ffffff;
  box-shadow: 0 0 0 4px rgba(6, 182, 212, 0.15);
  transform: translateY(-1px);
}

/* Gaya untuk Option di dalam Select */
select option {
  padding: 10px;
  background-color: #ffffff;
  color: #1e293b;
}

/* Animasi khusus saat panel input dirender */
#mainPanel select {
  animation: slideDown 0.4s ease-out;
}

@keyframes slideDown {
  from {
    opacity: 0;
    transform: translateY(-5px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

/* Label Styling agar lebih Profesional */
#mainPanel label {
  font-weight: 600;
  color: #475569;
  margin-top: 12px;
  margin-left: 2px;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  font-size: 11px;
}
.input-score.error {
  border: 2px solid #ef4444 !important;
  background-color: #fef2f2;
  animation: shake 0.2s ease-in-out;
}

@keyframes shake {
  0%, 100% { transform: translateX(0); }
  25% { transform: translateX(-4px); }
  75% { transform: translateX(4px); }
}
</style>
</head>
<body>
<div class="container">
  <header>
    <h1>Aplikasi Input Nilai ‚Äî UH / PTS / PAS</h1>
    <div class="auth-area">
      <div id="userLabel">Offline</div>
      <button class="btn small" id="btnLogin">Masukkan PIN Akses</button>
      <button class="btn small ghost" id="btnLogout" style="display:none">Logout</button>
    </div>
  </header>

  <div class="card">
    <div class="tabs" id="tabs">
      <div class="tab active" data-tab="UH">INPUT UH</div>
      <div class="tab" data-tab="PTS">INPUT PTS</div>
      <div class="tab" data-tab="PAS">INPUT PAS</div>
      <div class="tab" data-tab="DAFTAR_SANTRI">DAFTAR SANTRI</div>
      <div class="tab" data-tab="DAFTAR_MAPEL">DAFTAR MAPEL</div>
      <div class="tab" data-tab="DAFTAR_GURU">DAFTAR GURU</div>
      <div class="tab" data-tab="REKAP_SISWA">REKAP PERSISWA</div>
    </div>

    <div class="grid">
      <div class="panel" id="mainPanel"></div>


      <!-- PANEL TABEL -->
      <div class="panel" style="overflow:auto;">
        <h3 style="margin-top:0">Tabel Transaksi Nilai</h3>
        <div id="transactionsFilter"></div>
        <div class="transactions card" id="transactionsPanel"></div>
        <div class="footer-note">Data transaksi berisi semua nilai UH, PTS, PAS. Bisa edit/hapus. Disimpan di Firestore.</div>
      </div>
    </div>
  </div>

  <div style="height:18px"></div>
  <div style="color:var(--muted);font-size:13px">
    Tips: Gunakan tab <strong>DAFTAR SANTRI</strong> dan <strong>DAFTAR MAPEL</strong> untuk meng-custom nama santri & mapel. Perubahan langsung mempengaruhi dropdown dan daftar di tab nilai.
  </div>
</div>

<!-- Modal Preview Nilai -->
<div id="previewModal" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);justify-content:center;align-items:center;z-index:9999;">
  <div style="background:#fff;padding:16px;border-radius:12px;max-width:90%;max-height:80%;overflow:auto;position:relative;">
    <button id="closePreview" style="position:absolute;top:8px;right:8px;padding:4px 8px;border:none;background:#f00;color:#fff;border-radius:6px;cursor:pointer;">‚úï</button>
    <div id="previewContent"></div>
  </div>
</div>
<div id="toast-container"></div>
<!-- SheetJS for Excel parsing -->
<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<script type="module">
let currentPage = 1;
const rowsPerPage = 10; // Jumlah data per halaman
// ====== FIREBASE INIT ======
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
import { getFirestore, collection, doc, addDoc, getDocs, updateDoc, deleteDoc, 
  onSnapshot, query, orderBy, serverTimestamp, writeBatch, where 
} from "https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js";

// For Firebase JS SDK v7.20.0 and later, measurementId is optional
const firebaseConfig = {
  apiKey: "AIzaSyC_5sI9JYaR-bbGWBQFvfl2SX1xe2WRPuE",
  authDomain: "input-nilai-online-c4657.firebaseapp.com",
  projectId: "input-nilai-online-c4657",
  storageBucket: "input-nilai-online-c4657.firebasestorage.app",
  messagingSenderId: "676655325666",
  appId: "1:676655325666:web:0db190cedc613a165199bb",
  measurementId: "G-XYMHEHR27B"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

const santriCol = collection(db,'santri');
const mapelCol  = collection(db,'mapel');
const nilaiCol  = collection(db,'nilai');
const guruCol = collection(db, 'guru');
let guruCache = [];

// ====== CONFIGURASI AKSES ======
const PIN_USER  = "1234";  // PIN untuk penginput nilai
const PIN_ADMIN = "555";  // PIN untuk manajemen (Ganti sesuai keinginan)

// ==========================================
// 1. STATE & GLOBAL INITIALIZATION
// ==========================================
let userRole = null; 
let isAuthorized = false;

// Daftarkan ke window agar bisa diakses dari HTML (jika diperlukan)
window.loginAkses = loginAkses;
window.logoutAkses = logoutAkses;

// ==========================================
// 2. FUNGSI UPDATE UI (TOMBOL LOGOUT)
// ==========================================
function updateUIAfterLogin() {
    const btnLoginEl = document.getElementById('btnLogin');
    const btnLogoutEl = document.getElementById('btnLogout');
    const userLabel = document.getElementById('userLabel');

    if (isAuthorized) {
        // Jika login berhasil
        if (btnLoginEl) btnLoginEl.style.display = "none";
        if (btnLogoutEl) btnLogoutEl.style.display = "inline-flex";
        userLabel.innerText = userRole === 'ADMIN' ? "Mode: Admin" : "Mode: Penginput";
    } else {
        // Jika logout
        if (btnLoginEl) btnLoginEl.style.display = "inline-flex";
        if (btnLogoutEl) btnLogoutEl.style.display = "none";
        userLabel.innerText = "Offline / Terkunci";
        document.body.classList.remove('role-user');
    }
}

// ==========================================
// 3. FUNGSI LOGIN
// ==========================================
async function loginAkses() {
    const inputPin = prompt("Masukkan PIN Akses:");
    
    if (inputPin === PIN_ADMIN) {
        isAuthorized = true;
        userRole = 'ADMIN';
        document.body.classList.remove('role-user');
        activeTab = 'DAFTAR_SANTRI'; // Admin langsung ke manajemen data
    } else if (inputPin === PIN_USER) {
        isAuthorized = true;
        userRole = 'USER';
        document.body.classList.add('role-user');
        activeTab = 'UH'; // User langsung ke input nilai
    } else {
        alert("PIN Salah! Akses Ditolak.");
        return;
    }

    // Eksekusi perubahan tampilan
    updateUIAfterLogin();
    renderActiveTab();
    
    if (typeof showToast === 'function') {
        showToast("Berhasil", `Selamat Datang, ${userRole}`, "success");
    }
}

// ==========================================
// 4. FUNGSI LOGOUT
// ==========================================
function logoutAkses() {
    if (confirm("Apakah Anda yakin ingin logout?")) {
        // Reset Status
        isAuthorized = false;
        userRole = null;
        
        // Update UI & Kembali ke tampilan terkunci
        updateUIAfterLogin();
        renderActiveTab();
        
        if (typeof showToast === 'function') {
            showToast("Logout", "Anda telah keluar dari sistem.", "success");
        }
    }
}

// ==========================================
// 5. EVENT LISTENERS (Diletakkan di akhir module)
// ==========================================
// Menghubungkan tombol HTML dengan fungsi JavaScript di atas
document.addEventListener('DOMContentLoaded', () => {
    const btnLogin = document.getElementById('btnLogin');
    const btnLogout = document.getElementById('btnLogout');

    if (btnLogin) {
        btnLogin.addEventListener('click', loginAkses);
    }
    
    if (btnLogout) {
        btnLogout.addEventListener('click', logoutAkses);
    }
});


// ====== DOM ======
const mainPanel = document.getElementById('mainPanel');
const transactionsPanel = document.getElementById('transactionsPanel');
const transactionsFilter = document.getElementById('transactionsFilter');
const userLabel = document.getElementById('userLabel');
const btnLogin = document.getElementById('btnLogin');
const btnLogout = document.getElementById('btnLogout');

let activeTab = 'UH';
let santriCache = [];
let mapelCache = [];

// ====== HELPERS ======
function escapeHtml(str){ if(!str) return ''; return String(str).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;').replaceAll('"','&quot;'); }
function fmtDate(ts){
  try{ if(!ts) return ''; if(ts.toDate) return ts.toDate().toLocaleString(); return String(ts); }catch(e){ return ''; }
}


async function hapusDuplikatSantri(){
  const map = {};
  const batch = writeBatch(db);

  santriCache.forEach(s=>{
    if(!s.nisn) return;
    if(map[s.nisn]){
      batch.delete(doc(db,'santri',s.id));
    } else {
      map[s.nisn] = true;
    }
  });

  await batch.commit();
  alert('Duplikat santri berhasil dibersihkan');
}


// ====== REALTIME SNAPSHOTS ======
onSnapshot(query(santriCol, orderBy('name')), snap=>{
  santriCache = snap.docs.map(d=>({id:d.id, ...d.data()}));

  // üî• RESET filter santri jika sudah kosong
  const santriSelect = document.getElementById('filterSantri');
  if(santriSelect){
    santriSelect.innerHTML = '<option value="">Semua Santri</option>';
  }

  renderActiveTab();
  renderTransactionsWith(window._latestTx || []);
});

onSnapshot(query(mapelCol, orderBy('name')), snap=>{
  mapelCache = snap.docs.map(d=>({id:d.id, ...d.data()}));
  renderActiveTab();
  renderTransactionsWith(window._latestTx || []);
});
onSnapshot(query(nilaiCol, orderBy('createdAt','desc')), snap=>{
  window._latestTx = snap.docs.map(d=>({id:d.id, ...d.data()}));
  
  // HANYA jalankan render transaksi jika yang login adalah ADMIN
  if(userRole === 'ADMIN') {
    renderTransactionsWith(window._latestTx);
  }
  
  if(activeTab === 'REKAP_SISWA' && userRole === 'ADMIN') renderRekapSiswa();
});
onSnapshot(query(guruCol, orderBy('name')), snap => {
  guruCache = snap.docs.map(d => ({ id:d.id, ...d.data() }));

  // hanya render ulang jika tab guru sedang aktif
  if (activeTab === 'DAFTAR_GURU') {
    renderGuruEditor();
  }
});


// ====== TABS ======
document.querySelectorAll('.tab').forEach(t=> t.addEventListener('click', ()=>{
  activeTab = t.dataset.tab;
  renderActiveTab();
}));


function renderFilterUI() {
  const filterArea = document.getElementById('transactionsFilter');
  if (!filterArea) return;

  // 1. Ambil nilai yang sedang dipilih saat ini agar tidak ter-reset saat render ulang
  const currentSearch = document.getElementById('mainSearchSantri')?.value || "";
  const currentKelas = document.getElementById('mainFilterKelas')?.value || "";
  const currentMapel = document.getElementById('mainFilterMapel')?.value || "";
  const currentType = document.getElementById('mainFilterType')?.value || "";

  // 2. Ambil daftar kelas UNIK dari santriCache (Data Master)
  // Ini menjamin filter kelas selalu muncul meskipun belum ada transaksi nilai
  const daftarKelas = [...new Set(santriCache.map(s => s.kelas).filter(k => k))].sort();

  filterArea.innerHTML = `
    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-bottom:10px;">
      <input type="text" id="mainSearchSantri" placeholder="Cari Nama Santri..." 
        value="${escapeHtml(currentSearch)}" style="padding:10px; border-radius:8px; border:1px solid #ddd;">
      
      <select id="mainFilterKelas">
        <option value="">Semua Kelas</option>
        ${daftarKelas.map(k => `
          <option value="${k}" ${currentKelas === k ? 'selected' : ''}>Kelas ${k}</option>
        `).join('')}
      </select>

      <select id="mainFilterMapel">
        <option value="">Semua Mapel</option>
        ${mapelCache.map(m => `
          <option value="${m.name}" ${currentMapel === m.name ? 'selected' : ''}>${m.name}</option>
        `).join('')}
      </select>

      <select id="mainFilterType">
        <option value="">Semua Tipe</option>
        <option value="UH" ${currentType === 'UH' ? 'selected' : ''}>UH</option>
        <option value="PTS" ${currentType === 'PTS' ? 'selected' : ''}>PTS</option>
        <option value="PAS_LISAN" ${currentType === 'PAS_LISAN' ? 'selected' : ''}>PAS Lisan</option>
        <option value="PAS_TULIS" ${currentType === 'PAS_TULIS' ? 'selected' : ''}>PAS Tulis</option>
        <option value="PAS_PRAKTEK" ${currentType === 'PAS_PRAKTEK' ? 'selected' : ''}>PAS Praktek</option>
      </select>
    </div>
    <div style="margin-bottom:15px;">
      <button class="btn small ghost" onclick="window.exportToExcel()" style="width:100%; background:#22c55e; color:white; border:none; padding:12px;">
        üìó DOWNLOAD REKAP EXCEL (.XLSX)
      </button>
    </div>
  `;

  // 3. Pasang kembali event listener untuk semua elemen filter
  ['mainSearchSantri', 'mainFilterKelas', 'mainFilterMapel', 'mainFilterType'].forEach(id => {
    const el = document.getElementById(id);
    if (el) {
      // Gunakan 'change' untuk select dan 'input' untuk search agar lebih responsif
      const eventType = el.tagName === 'SELECT' ? 'change' : 'input';
      el.addEventListener(eventType, () => {
        currentPage = 1; 
        renderTransactionsWith(window._latestTx || []);
      });
    }
  });
}


function renderTransactionsWith(dataList) {
  const panel = document.getElementById('transactionsPanel');
  if (!isAuthorized || userRole !== 'ADMIN' || !panel) {
    if (panel) panel.innerHTML = "";
    return;
  }

  // 1. Ambil Nilai Filter (TAMBAHKAN fKelas DI SINI)
  const search = document.getElementById('mainSearchSantri')?.value.toLowerCase() || "";
  const fKelas = document.getElementById('mainFilterKelas')?.value || ""; // Ambil nilai kelas
  const fMapel = document.getElementById('mainFilterMapel')?.value || "";
  const fType = document.getElementById('mainFilterType')?.value || "";

  // 2. Logika Filter Data (TAMBAHKAN matchKelas)
  const filtered = dataList.filter(d => {
    const matchName = (d.santriName || "").toLowerCase().includes(search);
    const matchMapel = (fMapel === "" || d.mapel === fMapel);
    const matchType = (fType === "" || d.type === fType);
    const matchKelas = (fKelas === "" || d.kelas === fKelas); // Logika filter kelas

    // Pastikan matchKelas dimasukkan ke dalam return di bawah ini
    return matchName && matchMapel && matchType && matchKelas; 
  });

  // 3. Logika Paginasi
  const totalPages = Math.ceil(filtered.length / rowsPerPage);
  if (currentPage > totalPages) currentPage = Math.max(1, totalPages);
  
  const start = (currentPage - 1) * rowsPerPage;
  const end = start + rowsPerPage;
  const paginatedData = filtered.slice(start, end);

  // 4. Render HTML
  let html = `
    <div style="margin-bottom:10px; display:flex; justify-content:space-between; align-items:center;">
        <span class="badge">${filtered.length} Total Data</span>
        <button class="btn small delete-all" id="btnHapusSemua">HAPUS SEMUA</button>
    </div>
    <div class="table-responsive">
      <table>
        <thead>
          <tr>
            <th>Santri</th>
            <th>Kelas</th>
            <th>Mapel</th>
            <th>Guru</th>
            <th>Tipe</th>
            <th>Nilai</th>
            <th>Aksi</th>
          </tr>
        </thead>
        <tbody>
          ${paginatedData.map(d => {
            // Logika warna nilai (Remidial vs Lulus)
            const kkm = d.kkm || 70;
            const scoreColor = d.score < kkm ? '#ef4444' : '#22c55e';
            
            return `
            <tr>
              <td data-label="Santri">${escapeHtml(d.santriName)}</td>
              <td data-label="Kelas"><span class="badge">${escapeHtml(d.kelas || '-')}</span></td>
              <td data-label="Mapel">${escapeHtml(d.mapel)}</td>
              <td data-label="Guru">${escapeHtml(d.guru || '-')}</td>
              <td data-label="Tipe"><span class="badge badge-${d.type.toLowerCase()}">${d.type}</span></td>
              <td data-label="Nilai">
                <strong style="color: ${scoreColor}">${d.score}</strong>
                <small style="color:#94a3b8; font-size:10px;">(KKM: ${kkm})</small>
              </td>
              <td data-label="Aksi">
                <button class="btn small edit" onclick="window.editSingleNilai('${d.id}', ${d.score})">Edit</button>
                <button class="btn small delete" onclick="window.deleteSingleNilai('${d.id}')">Hapus</button>
              </td>
            </tr>
          `}).join('')}
        </tbody>
      </table>
    </div>

    <div style="margin-top:15px; display:flex; justify-content:center; gap:10px; align-items:center;">
      <button class="btn small ghost" ${currentPage === 1 ? 'disabled' : ''} id="prevPage">Prev</button>
      <span style="font-size:13px; font-weight:bold;">Halaman ${currentPage} dari ${totalPages || 1}</span>
      <button class="btn small ghost" ${currentPage >= totalPages ? 'disabled' : ''} id="nextPage">Next</button>
    </div>
  `;
  
  panel.innerHTML = html;

  // 5. Event Listeners
  const btnHapus = document.getElementById('btnHapusSemua');
  if (btnHapus) btnHapus.onclick = hapusSemuaNilai;

  document.getElementById('prevPage').onclick = () => {
    if (currentPage > 1) {
      currentPage--;
      renderTransactionsWith(window._latestTx);
    }
  };

  document.getElementById('nextPage').onclick = () => {
    if (currentPage < totalPages) {
      currentPage++;
      renderTransactionsWith(window._latestTx);
    }
  };
}


function renderActiveTab() {
  const userLabel = document.getElementById('userLabel');
  // Tambahkan baris ini di awal fungsi:
  mainPanel.style.animation = 'none';
  mainPanel.offsetHeight; // Trik "reflow" agar browser sadar animasi di-reset
  mainPanel.style.animation = null;
  const tabsElement = document.querySelectorAll('.tab');
  
  // 1. CEK OTORISASI UMUM
  if (!isAuthorized) {
    userLabel.innerText = "Terkunci";
    mainPanel.innerHTML = `<div style="text-align:center; padding:40px;"><h3>Akses Dibatasi</h3></div>`;
    transactionsPanel.innerHTML = ""; // Kosongkan tabel jika belum login
    transactionsFilter.innerHTML = ""; // Kosongkan filter jika belum login
    return;
  }

  userLabel.innerText = userRole === 'ADMIN' ? "Mode: Admin" : "Mode: Penginput";
  
  // 2. LOGIKA RENDER PANEL UTAMA (Sisi Kiri)
  const adminTabs = ['DAFTAR_SANTRI', 'DAFTAR_MAPEL', 'DAFTAR_GURU', 'REKAP_SISWA'];
  if (userRole === 'USER' && adminTabs.includes(activeTab)) {
    mainPanel.innerHTML = `<div class="card" style="text-align:center; color:red; padding:20px;"><h4>Akses Ditolak!</h4></div>`;
  } else {
    // Jalankan render tab yang dipilih
    if (['UH', 'PTS', 'PAS'].includes(activeTab)) renderInputTab(activeTab);
    else if (activeTab === 'DAFTAR_SANTRI') renderSantriEditor();
    else if (activeTab === 'DAFTAR_MAPEL') renderMapelEditor();
    else if (activeTab === 'DAFTAR_GURU') renderGuruEditor();
    else if (activeTab === 'REKAP_SISWA') renderRekapSiswa();
  }

  // 3. LOGIKA TABEL TRANSAKSI (Sisi Kanan) - INI KUNCINYA
  if (userRole === 'ADMIN') {
    // Tampilkan filter dan tabel hanya untuk ADMIN
    renderFilterUI(); 
    renderTransactionsWith(window._latestTx || []);
  } else {
    // Jika role adalah USER, paksa panel kanan kosong atau beri pesan
    document.getElementById('transactionsFilter').innerHTML = ""; 
    transactionsPanel.innerHTML = `
      <div style="text-align:center; padding:20px; color:#999;">
        <p>Riwayat transaksi hanya dapat dilihat oleh Admin.</p>
        <div style="font-size:40px">üö´</div>
      </div>`;
  }

  tabsElement.forEach(t => t.classList.toggle('active', t.dataset.tab === activeTab));
}


// ====== INPUT TAB ======
function renderInputTab(type) {
  // 1. Siapkan opsi Guru
  const guruOptions = guruCache.length
    ? `<option value="">-- Pilih Guru --</option>` + 
      guruCache.map(g => `<option value="${escapeHtml(g.name)}" data-mapel="${escapeHtml(g.mapel || '')}">${escapeHtml(g.name)}</option>`).join('')
    : '<option value="">-- kosong --</option>';

  // 2. Siapkan opsi Mapel
  const mapelOptions = mapelCache.length 
    ? `<option value="">-- Pilih Mapel --</option>` + 
      mapelCache.map(m => `<option value="${escapeHtml(m.name)}">${escapeHtml(m.name)}</option>`).join('') 
    : '<option value="">-- kosong --</option>';

  const daftarKelas = [...new Set(santriCache.map(s => s.kelas || "Tanpa Kelas"))].sort();

  mainPanel.innerHTML = `
    <h3>Input Nilai ‚Äî ${type}</h3>

    ${type === 'PAS' ? `
      <label>Jenis PAS</label>
      <select id="selectJenisPAS">
        <option value="">-- Pilih Jenis PAS --</option>
        <option value="PAS_LISAN">PAS Lisan</option>
        <option value="PAS_TULIS">PAS Tulis</option>
        <option value="PAS_PRAKTEK">PAS Praktek</option>
      </select>
    ` : ''}

    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
        <div>
            <label>Pilih Guru Pengampu</label>
            <select id="selectGuru">${guruOptions}</select>
        </div>
        <div>
            <label>Pilih Mapel</label>
            <select id="selectMapel">${mapelOptions}</select>
        </div>
    </div>

    <div style="margin-top:15px; background: #f0f4f8; padding: 12px; border-radius: 8px;">
      <label>üéØ Filter Kelas</label>
      <select id="filterKelasInput">
        <option value="SEMUA">-- Tampilkan Semua Kelas --</option>
        ${daftarKelas.map(k => `<option value="${k}">Kelas ${k}</option>`).join('')}
      </select>
      
      <label style="margin-top:10px;">üîç Cari Nama Santri</label>
      <input type="text" id="quickSearchSantri" placeholder="Ketik nama santri...">
    </div>

    <div style="margin-top:10px" class="santri-list" id="santriList">
      ${santriCache.map(s => `
        <div class="santri-row" data-id="${s.id}" data-kelas="${s.kelas || 'Tanpa Kelas'}" style="display: flex; justify-content: space-between; align-items: center; padding: 8px; border-bottom: 1px solid #eee;">
          <div style="flex:1">
            <strong class="santri-name">${escapeHtml(s.name)}</strong><br>
            <small style="color:#666">Kelas: ${escapeHtml(s.kelas || '-')}</small>
          </div>
          <div style="width:80px">
            <input type="number" 
                   class="input-score" 
                   data-id="${s.id}" 
                   placeholder="0-100" 
                   min="0" 
                   max="100" 
                   oninput="if(this.value > 100) this.value = 100; if(this.value < 0) this.value = 0;"
                   style="width:100%; padding:8px; border-radius:8px; border:1px solid #ddd;">
          </div>
        </div>
      `).join('')}
    </div>

    <div style="margin-top:20px; display:flex; gap:10px;">
      <button class="btn" id="btnSimpan" style="flex:1; padding: 12px; background: #28a745; color: white; border: none; border-radius: 8px; cursor: pointer;">SIMPAN NILAI</button>
    </div>
  `;

  // --- LOGIKA FILTER KELAS & SEARCH ---
  const doFilter = () => {
    const kelasTerpilih = document.getElementById('filterKelasInput').value;
    const kataKunci = document.getElementById('quickSearchSantri').value.toLowerCase();
    
    document.querySelectorAll('.santri-row').forEach(row => {
      const kelasSantri = row.dataset.kelas;
      // Perbaikan: Pastikan class .santri-name ada di HTML di atas
      const namaSantri = row.querySelector('.santri-name').innerText.toLowerCase();
      
      const matchKelas = (kelasTerpilih === "SEMUA" || kelasSantri === kelasTerpilih);
      const matchNama = namaSantri.includes(kataKunci);
      
      row.style.display = (matchKelas && matchNama) ? 'flex' : 'none';
    });
  };

  document.getElementById('filterKelasInput').addEventListener('change', doFilter);
  document.getElementById('quickSearchSantri').addEventListener('input', doFilter);

  // --- LOGIKA AUTO-NEXT (ENTER) ---
  const scoreInputs = mainPanel.querySelectorAll('.input-score');
  scoreInputs.forEach((input, index) => {
    input.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') {
        e.preventDefault();
        
        // Cari input selanjutnya yang sedang terlihat (tidak tersembunyi oleh filter)
        let nextInput = null;
        for (let i = index + 1; i < scoreInputs.length; i++) {
          if (scoreInputs[i].closest('.santri-row').style.display !== 'none') {
            nextInput = scoreInputs[i];
            break;
          }
        }

        if (nextInput) {
          nextInput.focus();
          nextInput.select();
        } else {
          if (confirm("Sudah mencapai baris terakhir. Simpan sekarang?")) {
            document.getElementById('btnSimpan').click();
          }
        }
      }
    });
  });

  // --- LOGIKA OTOMATISASI MAPEL ---
  const selGuru = document.getElementById('selectGuru');
  const selMapel = document.getElementById('selectMapel');
  selGuru.addEventListener('change', () => {
    const selectedOption = selGuru.options[selGuru.selectedIndex];
    const mapelDiampu = selectedOption.getAttribute('data-mapel');
    if (mapelDiampu) selMapel.value = mapelDiampu;
  });

  // --- LOGIKA SIMPAN ---
  document.getElementById('btnSimpan').onclick = () => prosesSimpanNilai(type);
}

async function prosesSimpanNilai(type) {
  const btn = document.getElementById('btnSimpan');
  const guru = document.getElementById('selectGuru').value;
  const mapel = document.getElementById('selectMapel').value;
  const finalType = (type === 'PAS') ? document.getElementById('selectJenisPAS').value : type;

  if (!guru || !mapel || !finalType) {
    alert("‚ö†Ô∏è Lengkapi data Guru, Mapel, dan Jenis Nilai!");
    return;
  }

  const inputs = document.querySelectorAll('.input-score');
  const batch = writeBatch(db);
  let count = 0;

  btn.disabled = true;
  btn.innerText = "‚è≥ Menyimpan...";

  inputs.forEach(inp => {
    const val = inp.value;
    if (val !== "") {
      const sId = inp.dataset.id;
      const sData = santriCache.find(s => s.id === sId);
      const newDocRef = doc(collection(db, "nilai"));
      
      batch.set(newDocRef, {
        santriId: sId,
        santriName: sData.name,
        kelas: sData.kelas || 'Tanpa Kelas',
        type: finalType,
        guru: guru,
        mapel: mapel,
        score: parseFloat(val),
        createdAt: serverTimestamp()
      });
      count++;
    }
  });

  if (count === 0) {
    alert("Isi minimal satu nilai.");
    btn.disabled = false;
    btn.innerText = "SIMPAN NILAI";
    return;
  }

  try {
    await batch.commit();
    alert(`‚úÖ Berhasil menyimpan ${count} data!`);
    inputs.forEach(i => i.value = "");
  } catch (err) {
    alert("‚ùå Gagal: " + err.message);
  } finally {
    btn.disabled = false;
    btn.innerText = "SIMPAN NILAI";
  }
}


async function saveScores(type) {
  const btnSimpan = document.getElementById('btnSimpan');
  const originalText = btnSimpan.innerHTML;

  const mapel = document.getElementById('selectMapel').value;
  const guru = document.getElementById('selectGuru').value;
  
  // 1. Validasi Input Dasar
  if (!mapel || !guru) return alert('Pilih Mapel dan Guru terlebih dahulu!');

  let finalType = type;
  if (type === 'PAS') {
    const valJenis = document.getElementById('selectJenisPAS').value;
    if (!valJenis) return alert('Pilih Jenis PAS!');
    finalType = valJenis;
  }

  // AMBIL DATA KKM DARI CACHE MAPEL
  const mapelData = mapelCache.find(m => m.name === mapel);
  const kkmAktif = mapelData ? (mapelData.kkm || 70) : 70; // Default 70 jika data kkm kosong

  const inputs = document.querySelectorAll('.input-score');
  const batch = writeBatch(db);
  let count = 0;
  let hasError = false; 

scoreInputs.forEach(inp => {
  const val = inp.value.trim();
  
  if (val !== "") {
    const numericValue = Number(val);

    // VALIDASI: Cek apakah itu angka dan dalam rentang 0-100
    if (isNaN(numericValue)) {
       showToast("Input harus berupa angka!", "error");
       inp.classList.add('error'); // Tambahkan visual merah
       return;
    }

    if (numericValue < 0 || numericValue > 100) {
       showToast("Nilai harus antara 0 - 100", "error");
       inp.classList.add('error');
       return;
    }

    // Jika lolos validasi, baru masukkan ke batch
    const sId = inp.dataset.id;
    const sObj = santriCache.find(x => x.id === sId);
    const ref = doc(nilaiCol);
    
    batch.set(ref, {
      santriId: sId,
      santriName: sObj.name,
      score: numericValue, // Simpan sebagai angka murni
      // ... field lainnya
    });
    count++;
  }
});

// 2. Proses Validasi Visual & Persiapan Data
inputs.forEach(inp => {
  const val = parseFloat(inp.value);
  
  if (!isNaN(val)) {
    const santriId = inp.dataset.id;
    
    // CARI DATA SANTRI DI CACHE UNTUK AMBIL KELASNYA
    const dataSantri = santriCache.find(s => s.id === santriId);
    
    const newDoc = doc(collection(db, 'nilai'));
    
    batch.set(newDoc, {
      santriId: santriId,
      santriName: dataSantri ? dataSantri.name : "Tanpa Nama",
      
      // INI YANG MEMBUAT KELAS MUNCUL DI TABEL TRANSAKSI
      kelas: (dataSantri && dataSantri.kelas) ? dataSantri.kelas : "-", 
      
      mapel: mapel,
      guru: guru,
      type: typeValue,
      score: val,
      createdAt: serverTimestamp()
    });
    
    count++;
  } // <-- Tutup IF
}); // <-- Tutup forEach

  // 3. Batalkan jika ada error visual
  if (hasError) {
    alert(`Terdapat nilai tidak valid (0-100). Periksa kolom merah.`);
    return; 
  }

  if (count === 0) {
    return alert("Tidak ada nilai yang diisi.");
  }

  // 4. Proses Simpan ke Firestore
  try {
    // Loading State
    btnSimpan.classList.add('btn-loading');
    btnSimpan.disabled = true;
    btnSimpan.innerHTML = `<span class="spinner"></span> Menyimpan...`;

    await batch.commit();

// 1. Siapkan data untuk ringkasan
let remedialCount = 0;
let lulusCount = 0;
let remedialListHtml = "";

inputs.forEach(input => {
    if (input.value.trim() !== "") {
        const score = Number(input.value);
        const santri = santriCache.find(s => s.id === input.dataset.id);
        
        if (score < kkmAktif) {
            remedialCount++;
            remedialListHtml += `
                <div class="remedial-item">
                    <span>${santri.name}</span>
                    <b style="color:#ef4444">${score}</b>
                </div>`;
        } else {
            lulusCount++;
        }
    }
});

// 2. Munculkan Toast Sukses
window.showToast("Berhasil Disimpan", `${count} data nilai berhasil diunggah.`);

// 3. Munculkan Summary Modal
const previewContent = document.getElementById('previewContent');
previewContent.innerHTML = `
    <div style="text-align:center; margin-bottom:15px;">
        <div style="font-size:40px;">üìä</div>
        <h2 style="margin:5px 0">Ringkasan Input</h2>
        <p style="color:var(--muted)">Mapel: ${mapel} (KKM: ${kkmAktif})</p>
    </div>

    <div class="summary-card">
        <div class="stat-box success">
            <small>Tuntas</small>
            <div style="font-size:20px; font-weight:800">${lulusCount}</div>
        </div>
        <div class="stat-box danger">
            <small>Remidial</small>
            <div style="font-size:20px; font-weight:800">${remedialCount}</div>
        </div>
    </div>

    ${remedialCount > 0 ? `
        <label>Daftar Santri Remidial:</label>
        <div class="remedial-list">${remedialListHtml}</div>
    ` : `
        <div style="text-align:center; padding:10px; color:#22c55e;">
            üéâ Selamat! Semua santri tuntas KKM.
        </div>
    `}
    
    <button class="btn" onclick="document.getElementById('previewModal').style.display='none'" 
            style="width:100%; margin-top:20px;">Selesai & Tutup</button>
`;

document.getElementById('previewModal').style.display = 'flex';

// 4. Bersihkan input seperti biasa
inputs.forEach(i => { i.value = ""; });

    window.showToast("Berhasil Disimpan", `${count} data nilai ${type} telah masuk ke database.`, "success");
    
    // Bersihkan semua input
    inputs.forEach(i => {
      i.value = "";
      i.style.border = "";
      i.style.backgroundColor = "";
    });

  } catch (error) {
    console.error("Error saat menyimpan:", error);
    alert("Gagal menyimpan data. Periksa koneksi internet.");
  } finally {
    // Kembalikan Tombol
    btnSimpan.classList.remove('btn-loading');
    btnSimpan.disabled = false;
    btnSimpan.innerHTML = originalText;
  }
}

async function hapusSemuaNilai() {
  if (userRole !== 'ADMIN') {
    alert("Akses Ditolak! Hanya Admin yang dapat menghapus seluruh data transaksi.");
    return;
  }
  const konfirmasi = confirm("PERINGATAN: Anda akan menghapus SELURUH data nilai di database...");
  if (!konfirmasi) return;

  const password = prompt("Masukkan PIN ADMIN untuk konfirmasi penghapusan massal:");
  if (password !== PIN_ADMIN) {
    alert("PIN Salah. Penghapusan dibatalkan.");
    return;
  }

  const batch = writeBatch(db);
  const snap = await getDocs(nilaiCol);
  snap.forEach(d => batch.delete(d.ref));
  await batch.commit();
  alert("Seluruh data nilai telah dibersihkan.");
}

// Fungsi untuk Edit Nilai Tunggal
window.editSingleNilai = async (id, oldScore) => {
  // Proteksi tambahan di sisi kode
  if (userRole !== 'ADMIN') {
    alert("Hanya Admin yang boleh mengedit nilai.");
    return;
  }

  const newScore = prompt(`Ubah nilai santri. (Nilai lama: ${oldScore})`, oldScore);

  // Jika user klik 'Cancel' atau tidak mengisi apapun
  if (newScore === null || newScore.trim() === "") return;

  const scoreNum = Number(newScore);

  // Validasi input angka
  if (isNaN(scoreNum) || scoreNum < 0 || scoreNum > 100) {
    alert("Gagal: Masukkan angka yang valid antara 0 - 100.");
    return;
  }

  try {
    const docRef = doc(db, 'nilai', id);
    await updateDoc(docRef, {
      score: scoreNum,
      updatedAt: serverTimestamp() // Mencatat kapan nilai terakhir diubah
    });
    // Tidak perlu refresh, onSnapshot akan otomatis memperbarui tabel
  } catch (error) {
    console.error("Gagal update:", error);
    alert("Terjadi kesalahan saat menyimpan perubahan.");
  }
};

// Pastikan fungsi hapus tunggal juga tersedia di window agar bisa diklik dari HTML
window.deleteSingleNilai = async (id) => {
  if (userRole !== 'ADMIN') return alert("Hanya Admin yang boleh menghapus.");
  if (!confirm("Apakah Anda yakin ingin menghapus data nilai ini?")) return;
  
  try {
    await deleteDoc(doc(db, 'nilai', id));
  } catch (e) {
    alert("Gagal menghapus data.");
  }
};


window.exportToExcel = () => {
  // 1. Ambil data yang sedang terfilter (dari cache data terakhir)
  const dataToExport = window._latestTx || [];
  
  if (dataToExport.length === 0) {
    alert("Tidak ada data untuk di-export.");
    return;
  }

  // 2. Format data agar rapi di Excel
  const excelData = dataToExport.map((d, index) => ({
    "No": index + 1,
    "Nama Santri": d.santriName,
    "Mata Pelajaran": d.mapel,
    "Guru Pengampu": d.guru || "-",
    "Tipe Nilai": d.type,
    "Skor": d.score,
    "Tanggal Input": d.createdAt ? d.createdAt.toDate().toLocaleString('id-ID') : "-"
  }));

  // 3. Proses konversi menggunakan SheetJS
  const worksheet = XLSX.utils.json_to_sheet(excelData);
  const workbook = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(workbook, worksheet, "Rekap Nilai");

  // 4. Atur lebar kolom otomatis (opsional)
  const wscols = [
    {wch: 5},  // No
    {wch: 25}, // Nama
    {wch: 20}, // Mapel
    {wch: 20}, // Guru
    {wch: 15}, // Tipe
    {wch: 10}, // Skor
    {wch: 20}  // Tanggal
  ];
  worksheet['!cols'] = wscols;

  // 5. Download file
  const fileName = `Rekap_Nilai_${new Date().toISOString().slice(0,10)}.xlsx`;
  XLSX.writeFile(workbook, fileName);
};


function showInteractivePreview(type){
  const inputs = document.querySelectorAll('.input-score');
  const data = Array.from(inputs)
    .map(i => {
      if(i.value.trim() === '') return null;
      const s = santriCache.find(s => s.id === i.dataset.id);
      return { santri: s.name, mapel: document.getElementById('selectMapel').value, type, nilai: i.value };
    })
    .filter(Boolean);

  if(!data.length) return alert('Tidak ada nilai untuk ditampilkan');

  const modal = document.getElementById('previewModal');
  modal.style.display = 'flex';

  modal.innerHTML = `
    <div style="background:#fff;padding:16px;border-radius:12px;max-width:95%;max-height:90%;overflow:auto;position:relative;">
      <button id="closePreview" style="position:absolute;top:8px;right:8px;padding:4px 8px;border:none;background:#f00;color:#fff;border-radius:6px;cursor:pointer;">‚úï</button>
      <h3 style="margin-top:0;margin-bottom:12px;">Preview Nilai Interaktif ‚Äî ${type}</h3>

      <div style="display:flex;flex-wrap:wrap;gap:12px;margin-bottom:12px;align-items:center;">
        <label>Pencarian Santri: <input type="text" id="searchSantri" placeholder="Cari santri..." style="padding:6px;border-radius:6px;border:1px solid #ccc;"></label>

        <label>Filter Mapel:
          <select id="filterMapel" style="padding:6px;border-radius:6px;border:1px solid #ccc;">
            <option value="">Semua Mapel</option>
            ${[...new Set(data.map(d => d.mapel))].map(m=>`<option value="${m}">${m}</option>`).join('')}
          </select>
        </label>

        <label>Filter Tipe:
          <select id="filterType" style="padding:6px;border-radius:6px;border:1px solid #ccc;">
            <option value="">Semua</option>
            <option value="UH">UH</option>
            <option value="PTS">PTS</option>
            <option value="PAS">PAS</option>
          </select>
        </label>

        <button class="btn small" id="btnCopyPreview">Copy ke Clipboard</button>
        <button class="btn small" id="btnExportPreview">Download CSV</button>
      </div>

      <div style="overflow:auto;">
        <table border="1" cellpadding="6" cellspacing="0" style="width:100%;border-collapse:collapse;text-align:left;">
          <thead style="background:#f0f0f0;">
            <tr>
              <th style="padding:8px;">No</th>
              <th style="padding:8px;">Santri</th>
              <th style="padding:8px;">Mapel</th>
              <th style="padding:8px;">Tipe</th>
              <th style="padding:8px;">Nilai</th>
            </tr>
          </thead>
          <tbody id="previewTableBody"></tbody>
        </table>
      </div>
    </div>
  `;

  const tableBody = document.getElementById('previewTableBody');
  const searchInput = document.getElementById('searchSantri');
  const filterMapel = document.getElementById('filterMapel');
  const filterType = document.getElementById('filterType');

  const renderTable = () => {
    const search = searchInput.value.toLowerCase();
    const fMapel = filterMapel.value;
    const fType = filterType.value;

    const filtered = data.filter(d => 
      (!fMapel || d.mapel === fMapel) &&
      (!fType || d.type === fType) &&
      d.santri.toLowerCase().includes(search)
    );

    if(!filtered.length){
      tableBody.innerHTML = `<tr><td colspan="5" style="text-align:center;color:var(--muted)">Tidak ada data sesuai filter</td></tr>`;
      return;
    }

    tableBody.innerHTML = filtered.map((d,i)=>`
      <tr style="border-bottom:1px solid #eee;">
        <td style="padding:6px;">${i+1}</td>
        <td style="padding:6px;">${escapeHtml(d.santri)}</td>
        <td style="padding:6px;">${escapeHtml(d.mapel)}</td>
        <td style="padding:6px;">${escapeHtml(d.type)}</td>
        <td style="padding:6px;">${d.nilai}</td>
      </tr>
    `).join('');
  };

  renderTable();

  // Event filter / search
  searchInput.addEventListener('input', renderTable);
  filterMapel.addEventListener('change', renderTable);
  filterType.addEventListener('change', renderTable);

  // Close modal
  document.getElementById('closePreview').onclick = () => modal.style.display='none';
  modal.onclick = e => { if(e.target === modal) modal.style.display='none'; }

  // Copy ke clipboard
  document.getElementById('btnCopyPreview').onclick = () => {
    const rows = Array.from(tableBody.querySelectorAll('tr'))
      .map(r => Array.from(r.children).map(td => td.innerText).join(','))
      .join('\n');
    navigator.clipboard.writeText(rows).then(()=> alert('Disalin ke clipboard!'));
  };

  // Export CSV
  document.getElementById('btnExportPreview').onclick = () => {
    const rows = Array.from(tableBody.querySelectorAll('tr'))
      .map(r => Array.from(r.children).map(td => `"${td.innerText}"`).join(','));
    const blob = new Blob([['No,Santri,Mapel,Tipe,Nilai'].concat(rows).join('\n')], {type:'text/csv'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href = url; a.download = `preview_nilai_interaktif.csv`; a.click();
    URL.revokeObjectURL(url);
  };
}


// ====== DAFTAR SANTRI =====
function renderSantriEditor() {
  // 1. RENDER HTML KE PANEL UTAMA
  mainPanel.innerHTML = `
    <h3>Daftar Santri</h3>
    <hr style="margin:12px 0">

    <h4>Tambah Santri Manual</h4>
    <div style="display:grid;grid-template-columns:1fr 1fr 1fr auto;gap:8px;align-items:end;margin-bottom:12px">
      <div>
        <label>Nama Santri</label>
        <input type="text" id="newSantriName" placeholder="Nama santri">
      </div>
      <div>
        <label>NISN</label>
        <input type="text" id="newSantriNISN" placeholder="NISN">
      </div>
      <div>
        <label>Kelas</label>
        <select id="addKelas">
          <option value="7">Kelas 7</option>
          <option value="8">Kelas 8</option>
          <option value="9">Kelas 9</option>
          <option value="10">Kelas 10</option>
          <option value="11">Kelas 11</option>
          <option value="12">Kelas 12</option>
        </select>
      </div>
      <button class="btn" id="btnSimpanSantri">TAMBAH</button>
    </div>

    <hr style="margin:12px 0">

    <div style="background:#f1f5f9; padding:12px; border-radius:8px; margin-bottom:12px;">
      <label style="font-weight:bold">Import dari Excel</label><br>
      <input type="file" id="fileSantri" accept=".xlsx,.csv" style="margin:8px 0;" />
      <div style="display:flex; gap:8px; align-items:center;">
        <select id="sheetSelector" disabled style="width:200px; padding:6px;">
          <option value="">-- Pilih Sheet --</option>
        </select>
        <button class="btn small" id="btnImportExcel">Import Sekarang</button>
      </div>
      <small style="color: #64748b;">Format kolom: <b>name | kelas | nisn</b> (Mulai baris ke-2)</small>
    </div>

    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
        <strong>Total: ${santriCache.length} Santri</strong>
        <button class="btn small delete-all" id="btnDeleteSelected">Hapus Terpilih</button>
    </div>

    <div class="table-responsive">
      <table id="santriTable">
        <thead>
          <tr>
            <th><input type="checkbox" id="chkAllSantri"></th>
            <th>Nama</th>
            <th>Kelas</th>
            <th>NISN</th>
            <th>Aksi</th>
          </tr>
        </thead>
        <tbody>
          ${santriCache.map(s => `
            <tr data-id="${s.id}">
              <td><input type="checkbox" class="chkSantri" data-id="${s.id}"></td>
              <td><input class="editable-input editableName" value="${escapeHtml(s.name || '')}"></td>
              <td><input class="editable-input editableKelas" value="${escapeHtml(s.kelas || '')}"></td>
              <td><input class="editable-input editableNISN" value="${escapeHtml(s.nisn || '')}"></td>
              <td><button class="btn small delete btnRemoveSantri">Hapus</button></td>
            </tr>
          `).join('')}
        </tbody>
      </table>
    </div>
  `;

  // --- 2. LOGIKA TAMBAH MANUAL ---
  const btnSimpan = document.getElementById('btnSimpanSantri');
  btnSimpan.onclick = async () => {
    const nameEl = document.getElementById('newSantriName');
    const nisnEl = document.getElementById('newSantriNISN');
    const kelasEl = document.getElementById('addKelas');

    const name = nameEl.value.trim();
    const nisn = nisnEl.value.trim();
    const kelas = kelasEl.value;

    if (!name) return alert('Nama santri wajib diisi!');

    // Cek duplikat NISN di cache lokal
    if (nisn && santriCache.some(s => String(s.nisn) === nisn)) {
      return alert('Gagal! NISN ' + nisn + ' sudah ada.');
    }

    btnSimpan.disabled = true;
    btnSimpan.innerHTML = "...";

    try {
      await addDoc(santriCol, {
        name,
        kelas,
        nisn,
        createdAt: serverTimestamp()
      });
      nameEl.value = '';
      nisnEl.value = '';
      alert('Santri berhasil ditambahkan');
    } catch (e) {
      alert("Error: " + e.message);
    } finally {
      btnSimpan.disabled = false;
      btnSimpan.innerHTML = "TAMBAH";
    }
  };

  // --- 3. LOGIKA EXCEL (IMPORT) ---
  const fileInput = document.getElementById('fileSantri');
  const sheetSelector = document.getElementById('sheetSelector');

  fileInput.onchange = async (e) => {
    const file = e.target.files[0];
    if (!file) return;
    try {
      const data = await file.arrayBuffer();
      const workbook = XLSX.read(data);
      sheetSelector.innerHTML = '<option value="">-- Pilih Sheet --</option>';
      workbook.SheetNames.forEach(name => {
        sheetSelector.innerHTML += `<option value="${name}">${name}</option>`;
      });
      sheetSelector.disabled = false;
      window._tempWorkbook = workbook; 
    } catch (err) {
      alert("Gagal membaca file excel.");
    }
  };

  document.getElementById('btnImportExcel').onclick = async () => {
    const sheetName = sheetSelector.value;
    const btnImport = document.getElementById('btnImportExcel');

    if (!sheetName || !window._tempWorkbook) return alert('Pilih file dan sheet!');

    const worksheet = window._tempWorkbook.Sheets[sheetName];
    const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: ["name", "kelas", "nisn"], range: 1 });

    const existingNISN = santriCache.map(s => String(s.nisn || '').trim());
    const batch = writeBatch(db);
    let added = 0;

    btnImport.disabled = true;
    btnImport.innerHTML = "Memproses...";

    jsonData.forEach(r => {
      const nisn = String(r.nisn || '').trim();
      const name = String(r.name || '').trim();
      
      if (name && (!nisn || !existingNISN.includes(nisn))) {
        const newRef = doc(santriCol);
        batch.set(newRef, {
          name: name,
          kelas: String(r.kelas || '').trim(),
          nisn: nisn,
          createdAt: serverTimestamp()
        });
        added++;
      }
    });

    if (added > 0) {
      await batch.commit();
      alert(`Berhasil mengimpor ${added} santri.`);
      fileInput.value = ""; 
      sheetSelector.disabled = true;
    } else {
      alert("Tidak ada data baru yang valid untuk diimpor.");
    }
    btnImport.disabled = false;
    btnImport.innerHTML = "Import Sekarang";
  };

  // --- 4. LOGIKA UPDATE OTOMATIS (IN-LINE EDIT) ---
  document.querySelectorAll('.editable-input').forEach(input => {
    input.onchange = async (e) => {
      const tr = e.target.closest('tr');
      const id = tr.dataset.id;
      const field = e.target.classList.contains('editableName') ? 'name' : 
                    e.target.classList.contains('editableKelas') ? 'kelas' : 'nisn';
      
      try {
        await updateDoc(doc(db, 'santri', id), { 
          [field]: e.target.value.trim() 
        });
        console.log(`Updated ${field} for ${id}`);
      } catch (err) {
        alert("Gagal memperbarui data.");
        console.error(err);
      }
    };
  });

  // --- 5. LOGIKA HAPUS (SINGLE & MASSAL) ---
  // Checkbox Select All
  document.getElementById('chkAllSantri').onclick = (e) => {
    document.querySelectorAll('.chkSantri').forEach(c => c.checked = e.target.checked);
  };

  // Hapus Terpilih (Batch Delete)
  document.getElementById('btnDeleteSelected').onclick = async () => {
    const checked = Array.from(document.querySelectorAll('.chkSantri:checked'));
    if (!checked.length) return alert("Pilih data yang ingin dihapus!");
    if (!confirm(`Hapus ${checked.length} santri terpilih?`)) return;

    const batch = writeBatch(db);
    checked.forEach(cb => {
      batch.delete(doc(db, 'santri', cb.dataset.id));
    });
    
    try {
      await batch.commit();
      alert("Data berhasil dihapus.");
    } catch (err) {
      alert("Gagal menghapus data terpilih.");
    }
  };

  // Hapus Satuan
  document.querySelectorAll('.btnRemoveSantri').forEach(btn => {
    btn.onclick = async (e) => {
      const id = e.target.closest('tr').dataset.id;
      if (confirm('Hapus santri ini?')) {
        try {
          await deleteDoc(doc(db, 'santri', id));
          alert("Santri dihapus.");
        } catch (err) {
          alert("Gagal menghapus santri.");
        }
      }
    };
  });
}


async function previewExcelFile(){
  const fileInput = document.getElementById('excelInput');
  if(!fileInput.files.length) return alert('Pilih file Excel terlebih dahulu');
  const file = fileInput.files[0];
  const reader = new FileReader();
  reader.onload = function(e){
    const data = new Uint8Array(e.target.result);
    const workbook = XLSX.read(data, { type: 'array' });
    const sheetName = workbook.SheetNames[0];
    const worksheet = workbook.Sheets[sheetName];
    const jsonData = XLSX.utils.sheet_to_json(worksheet);
    if(!jsonData.length) return alert('File kosong atau tidak cocok');
    // Show preview in modal
    const modal = document.getElementById('previewModal');
    modal.style.display = 'flex';
    modal.innerHTML = `<div style="background:#fff;padding:16px;border-radius:12px;max-width:95%;max-height:90%;overflow:auto;position:relative;"><button id="closePreview" style="position:absolute;top:8px;right:8px;padding:4px 8px;border:none;background:#f00;color:#fff;border-radius:6px;cursor:pointer;">‚úï</button><h3 style="margin-top:0">Preview Data Excel (${jsonData.length} baris)</h3><div style="overflow:auto;"><table style="width:100%;border-collapse:collapse"><thead><tr>${Object.keys(jsonData[0]).map(h=>`<th style="padding:8px;border:1px solid #eee">${escapeHtml(h)}</th>`).join('')}</tr></thead><tbody>${jsonData.map(r=>`<tr>${Object.values(r).map(v=>`<td style="padding:6px;border:1px solid #eee">${escapeHtml(String(v||''))}</td>`).join('')}</tr>`).join('')}</tbody></table></div></div>`;
    document.getElementById('closePreview').onclick = ()=> modal.style.display='none';
    modal.onclick = e => { if(e.target === modal) modal.style.display='none'; }
  };
  reader.readAsArrayBuffer(file);
}


async function importSantriExcel(){
  const fileInput = document.getElementById('excelInput');
  if(!fileInput.files.length) return alert('Pilih file Excel terlebih dahulu');
  const file = fileInput.files[0];
  const reader = new FileReader();

  reader.onload = async function(e){
    const data = new Uint8Array(e.target.result);
    const workbook = XLSX.read(data, { type: 'array' });
    const sheetName = workbook.SheetNames[0];
    const worksheet = workbook.Sheets[sheetName];
    const jsonData = XLSX.utils.sheet_to_json(worksheet);

    if(!jsonData.length) return alert('File kosong atau format tidak sesuai');

    // expected headers: Nama, Kelas, Alamat, NISN (case-insensitive)
    // normalize keys
    const normalized = jsonData.map(row=>{
      const out = {};
      Object.keys(row).forEach(k=>{
        const key = k.toString().trim().toLowerCase();
        if(key==='nama' || key==='name') out.name = row[k];
        else if(key==='kelas') out.kelas = row[k];
        else if(key==='alamat') out.alamat = row[k];
        else if(key==='nisn') out.nisn = row[k];
      });
      return out;
    }).filter(r=>r.name && String(r.name).trim());

    if(!normalized.length) return alert('Tidak menemukan kolom Nama (header "Nama")');

    // Check duplicates by NISN in santriCache
    const batch = writeBatch(db);
    let added = 0;
    let skipped = 0;

    normalized.forEach(r=>{
      const nisn = r.nisn ? String(r.nisn).trim() : '';
      const exists = nisn && santriCache.some(s => s.nisn && String(s.nisn).trim() === nisn);
      if(exists){ skipped++; return; }
      const ref = doc(collection(db,'santri'));
      batch.set(ref, { name: String(r.name).trim(), kelas: r.kelas || '', alamat: r.alamat || '', nisn: nisn || '', createdAt: serverTimestamp() });
      added++;
    });

    if(added===0){ alert(`Tidak ada data baru yang ditambahkan. Dilewati: ${skipped} duplikat (berdasarkan NISN).`); return; }

    try{
      await batch.commit();
      alert(`Import selesai. Ditambahkan: ${added}. Dilewati karena duplikat NISN: ${skipped}.`);
      fileInput.value = '';
      renderSantriEditor();
    }catch(err){ console.error(err); alert('Gagal mengimport: '+err.message); }
  };

  reader.readAsArrayBuffer(file);
}


function renderMapelEditor() {
  mainPanel.innerHTML = `
    <h3>Daftar Mata Pelajaran & KKM</h3>
    <div class="card" style="margin-bottom: 20px; border: 1px solid var(--primary-soft);">
      <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 10px;">
        <div>
          <label>Nama Mata Pelajaran</label>
          <input type="text" id="inputMapelName" placeholder="Contoh: Nahwu Wadhih">
        </div>
        <div>
          <label>KKM</label>
          <input type="number" id="inputMapelKKM" placeholder="0-100" min="0" max="100">
        </div>
      </div>
      <button class="btn" id="btnAddMapel" style="margin-top: 15px; width: 100%;">
        ‚ûï TAMBAH MATA PELAJARAN
      </button>
    </div>

    <div class="santri-list" id="mapelListContainer">
      <div style="padding: 8px; font-weight: bold; color: var(--muted); display: flex; border-bottom: 2px solid #eee;">
        <span style="flex: 2;">Mata Pelajaran</span>
        <span style="flex: 1; text-align: center;">KKM</span>
        <span style="flex: 1.5; text-align: right;">Aksi</span>
      </div>
      ${mapelCache.length === 0 ? '<p style="text-align:center; padding:20px;">Belum ada data mapel.</p>' : 
        mapelCache.map(m => `
        <div class="santri-row" style="display: flex; justify-content: space-between; align-items: center; padding: 10px 8px;">
          <div style="flex: 2;">
            <strong style="color: var(--primary-dark);">${escapeHtml(m.name)}</strong>
          </div>
          <div style="flex: 1; text-align: center;">
            <span class="badge" style="background: var(--primary-soft); font-size: 14px; padding: 4px 10px;">
              ${m.kkm || 70}
            </span>
          </div>
          <div style="flex: 1.5; text-align: right; display: flex; gap: 5px; justify-content: flex-end;">
            <button class="btn small edit" onclick="window.editMapelKKM('${m.id}', '${escapeHtml(m.name)}', ${m.kkm || 70})">Edit</button>
            <button class="btn small delete" onclick="window.deleteMapel('${m.id}')">Hapus</button>
          </div>
        </div>
      `).join('')}
    </div>
  `;

  // --- LOGIKA EVENT HANDLER ---

  // 1. Tambah Mapel
  document.getElementById('btnAddMapel').onclick = async () => {
    const nameInput = document.getElementById('inputMapelName');
    const kkmInput = document.getElementById('inputMapelKKM');
    const name = nameInput.value.trim();
    const kkm = parseInt(kkmInput.value);

    if (!name || isNaN(kkm)) { alert("Mohon isi Nama Mapel dan KKM!"); return; }
    if (kkm < 0 || kkm > 100) { alert("KKM harus 0 - 100!"); return; }

    try {
      await addDoc(mapelCol, { name, kkm, createdAt: serverTimestamp() });
      nameInput.value = ""; kkmInput.value = "";
      // Re-render akan dipicu otomatis oleh onSnapshot jika Anda menggunakannya
    } catch (e) { alert("Gagal menambah mapel."); }
  };

  // 2. Hapus Mapel (Didaftarkan ke window agar bisa dipanggil dari HTML onclick)
  window.deleteMapel = async (id) => {
    if (confirm("Apakah Anda yakin ingin menghapus mata pelajaran ini?")) {
      try {
        // Mengasumsikan 'db' dan 'doc' sudah diimport dari firebase/firestore
        const docRef = doc(db, "mapel", id); 
        await deleteDoc(docRef);
        // Note: MapelCache akan terupdate otomatis jika ada listener onSnapshot
      } catch (e) {
        console.error("Error deleting doc: ", e);
        alert("Gagal menghapus mata pelajaran.");
      }
    }
  };
}


function renderRekapSiswa(page = 1) {
  // --- 1. Helper & Inisialisasi ---
  const avg = (arr) => arr.length ? arr.reduce((a, b) => a + b, 0) / arr.length : 0;

  // Load Pengaturan dari UI atau LocalStorage
  let rowsPerPage = parseInt(localStorage.getItem("rekap_rows_per_page") || "10");
  const weightUH = parseFloat(document.getElementById('weightUH')?.value) || 0.3;
  const weightPTS = parseFloat(document.getElementById('weightPTS')?.value) || 0.3;
  const weightPAS = parseFloat(document.getElementById('weightPAS')?.value) || 0.4;
  
  // Ambil Nilai Filter
  const fStatus = document.getElementById('rekapFilterStatus')?.value || "SEMUA";
  const fKelas = document.getElementById('rekapFilterKelas')?.value || "SEMUA";
  const fMapel = document.getElementById('rekapFilterMapel')?.value || "SEMUA";

  // --- 2. Pengelompokan Data (Grouping) ---
  const grouped = {};
  (window._latestTx || []).forEach(t => {
    if (!grouped[t.santriName]) grouped[t.santriName] = [];
    grouped[t.santriName].push(t);
  });

  // --- 3. Pengolahan Data & Perhitungan NA ---
  let rawTableData = [];
  Object.keys(grouped).forEach(sName => {
    const distinctMapels = [...new Set(grouped[sName].map(t => t.mapel))];
    
    distinctMapels.forEach(mName => {
      // Filter Mapel (Dropdown Tunggal)
      if (fMapel !== "SEMUA" && mName !== fMapel) return;

      const records = grouped[sName].filter(t => t.mapel === mName);
      const sKelas = records[0]?.kelas || '-';

      // Filter Kelas (Dropdown)
      if (fKelas !== "SEMUA" && sKelas !== fKelas) return;
      
      const uhScores = records.filter(t => t.type === 'UH').map(t => t.score);
      const ptsScores = records.filter(t => t.type === 'PTS').map(t => t.score);
      
      const pasLisan = records.filter(t => t.type === 'PAS_LISAN').map(t => t.score);
      const pasTulis = records.filter(t => t.type === 'PAS_TULIS').map(t => t.score);
      const pasPraktek = records.filter(t => t.type === 'PAS_PRAKTEK').map(t => t.score);
      
      const allPasScores = [...pasLisan, ...pasTulis, ...pasPraktek];

      const avgUH = uhScores.length ? avg(uhScores) : 0;
      const avgPTS = ptsScores.length ? avg(ptsScores) : 0;
      const avgPAS = allPasScores.length ? avg(allPasScores) : 0;

      const naValue = (avgUH * weightUH) + (avgPTS * weightPTS) + (avgPAS * weightPAS);
      const finalNA = Number(naValue.toFixed(2));

      const mapelRef = (typeof mapelCache !== 'undefined' ? mapelCache : []).find(m => m.name === mName);
      const kkm = mapelRef ? parseFloat(mapelRef.kkm || 70) : 70;
      const status = finalNA < kkm ? "REMIDI" : "LULUS";

      rawTableData.push({
        santri: sName,
        kelas: sKelas,
        mapel: mName,
        kkm: kkm,
        uh: uhScores.length ? Number(avgUH.toFixed(2)) : null,
        pts: ptsScores.length ? Number(avgPTS.toFixed(2)) : null,
        pasLisan: pasLisan.length ? avg(pasLisan).toFixed(1) : null,
        pasTulis: pasTulis.length ? avg(pasTulis).toFixed(1) : null,
        pasPraktek: pasPraktek.length ? avg(pasPraktek).toFixed(1) : null,
        pasAvg: allPasScores.length ? Number(avgPAS.toFixed(2)) : null,
        na: finalNA,
        status: status
      });
    });
  });

  // --- 4. Filter Status ---
  const filteredData = rawTableData.filter(item => {
    if (fStatus === "REMIDI") return item.status === "REMIDI";
    if (fStatus === "LULUS") return item.status === "LULUS";
    return true;
  });

  // --- 5. Paginasi ---
  const totalRows = filteredData.length;
  const totalPages = Math.max(1, Math.ceil(totalRows / rowsPerPage));
  const currentPage = page > totalPages ? totalPages : (page < 1 ? 1 : page);
  const startIdx = (currentPage - 1) * rowsPerPage;
  const paginatedRows = filteredData.slice(startIdx, startIdx + rowsPerPage);

  // --- 6. Render UI ---
  
  // Ambil list unik Kelas & Mapel untuk Dropdown
  const listKelasUnik = [...new Set((typeof santriCache !== 'undefined' ? santriCache : []).map(s => s.kelas))].filter(k => k).sort();
  const mapelOptions = (typeof mapelCache !== 'undefined' ? mapelCache : [])
    .map(m => `<option value="${m.name}" ${fMapel === m.name ? 'selected' : ''}>${m.name}</option>`)
    .join('');

  let html = `
    <div class="panel">
      <h3 style="margin-top:0">REKAP NILAI AKHIR (NA)</h3>
      
      <div style="background:#f8fafc; padding:15px; border-radius:12px; border:1px solid #e2e8f0; margin-bottom:20px;">
        <div class="grid" style="grid-template-columns: 1.5fr 1fr; gap:20px;">
          <div>
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-bottom:10px;">
               <div>
                  <label><b>1. Filter Kelas:</b></label>
                  <select id="rekapFilterKelas" style="width:100%; padding:10px; border-radius:8px; border:1px solid #ccc;">
                    <option value="SEMUA">Semua Kelas</option>
                    ${listKelasUnik.map(k => `<option value="${k}" ${fKelas === k ? 'selected' : ''}>Kelas ${k}</option>`).join('')}
                  </select>
               </div>
               <div>
                  <label><b>2. Filter Mapel:</b></label>
                  <select id="rekapFilterMapel" style="width:100%; padding:10px; border-radius:8px; border:1px solid #ccc;">
                    <option value="SEMUA">Semua Mapel</option>
                    ${mapelOptions}
                  </select>
               </div>
            </div>

            <label style="display:block; margin-top:10px;"><b>3. Filter Status:</b></label>
            <select id="rekapFilterStatus" style="width:100%; padding:10px; border-radius:8px; border:1px solid var(--primary);">
              <option value="SEMUA" ${fStatus==='SEMUA'?'selected':''}>Tampilkan Semua Status</option>
              <option value="REMIDI" ${fStatus==='REMIDI'?'selected':''}>Hanya Remidi ( < KKM )</option>
              <option value="LULUS" ${fStatus==='LULUS'?'selected':''}>Hanya Lulus ( Tuntas )</option>
            </select>
          </div>

          <div style="background:#fff; padding:10px; border-radius:10px; border:1px dashed #cbd5e1;">
            <label><b>4. Atur Bobot Nilai:</b></label>
            <div style="margin-top:5px;">
              <small>UH</small> <input type="number" id="weightUH" value="${weightUH}" step="0.1" style="width:60px; float:right">
              <div style="clear:both; margin-bottom:8px;"></div>
              <small>PTS</small> <input type="number" id="weightPTS" value="${weightPTS}" step="0.1" style="width:60px; float:right">
              <div style="clear:both; margin-bottom:8px;"></div>
              <small>PAS</small> <input type="number" id="weightPAS" value="${weightPAS}" step="0.1" style="width:60px; float:right">
              <div style="clear:both; margin-top:10px; border-top:1px solid #eee; padding-top:5px;">
                <button class="btn small" style="width:100%" id="btnUpdateNA">Update & Hitung</button>
              </div>
            </div>
          </div>
        </div>

        <div style="margin-top:15px; display:flex; gap:10px; align-items:center;">
          <button class="btn small edit" id="btnExportExcel">üìó Download Excel</button>
          <span class="badge" style="padding:10px; background:var(--primary-soft); color:var(--primary-dark)">Ditemukan: ${totalRows} Data</span>
        </div>
      </div>

      <div class="table-responsive">
        <table style="width:100%; font-size:12px;">
          <thead>
            <tr style="background:#f1f5f9">
              <th>Santri</th>
              <th>Kelas</th>
              <th>Mapel</th>
              <th>Rata UH</th>
              <th>PTS</th>
              <th>PAS L</th>
              <th>PAS T</th>
              <th>PAS P</th>
              <th style="background:#e2e8f0; text-align:center;">N.A</th>
            </tr>
          </thead>
          <tbody>
            ${paginatedRows.length ? paginatedRows.map(r => {
              const isRemidi = r.status === "REMIDI";
              const naStyle = isRemidi 
                ? "background:#ef4444; color:#fff; padding:4px 6px; border-radius:4px; font-weight:bold;" 
                : "background:#22c55e; color:#fff; padding:4px 6px; border-radius:4px; font-weight:bold;";
              
              return `
                <tr>
                  <td><b>${r.santri}</b></td>
                  <td align="center"><span class="badge">${r.kelas}</span></td>
                  <td>${r.mapel} <br><small style="color:gray">KKM: ${r.kkm}</small></td>
                  <td align="center">${r.uh ?? '-'}</td>
                  <td align="center">${r.pts ?? '-'}</td>
                  <td align="center" style="color:var(--primary-dark)">${r.pasLisan ?? '-'}</td>
                  <td align="center" style="color:var(--primary-dark)">${r.pasTulis ?? '-'}</td>
                  <td align="center" style="color:var(--primary-dark)">${r.pasPraktek ?? '-'}</td>
                  <td align="center"><span style="${naStyle}">${r.na}</span></td>
                </tr>
              `;
            }).join('') : '<tr><td colspan="9" align="center" style="padding:20px;">Data tidak ditemukan. Pastikan filter sudah benar.</td></tr>'}
          </tbody>
        </table>
      </div>

      <div style="margin-top:15px; display:flex; justify-content:center; align-items:center; gap:15px;">
        <button class="btn small ghost" id="pgPrev" ${currentPage<=1?'disabled':''}>Prev</button>
        <span>Hal. <b>${currentPage}</b> / ${totalPages}</span>
        <button class="btn small ghost" id="pgNext" ${currentPage>=totalPages?'disabled':''}>Next</button>
        <select id="rowsPerPageSelect" style="width:auto; padding:5px; border-radius:5px;">
          ${[10,20,50,100,500].map(v => `<option value="${v}" ${rowsPerPage===v?'selected':''}>${v} baris</option>`).join('')}
        </select>
      </div>
    </div>
  `;

  document.getElementById('mainPanel').innerHTML = html;

  // --- 7. Event Handlers ---
  document.getElementById('rekapFilterStatus').onchange = () => renderRekapSiswa(1);
  document.getElementById('rekapFilterKelas').onchange = () => renderRekapSiswa(1);
  document.getElementById('rekapFilterMapel').onchange = () => renderRekapSiswa(1);
  document.getElementById('btnUpdateNA').onclick = () => renderRekapSiswa(1);
  
  document.getElementById("rowsPerPageSelect").onchange = (e) => {
    localStorage.setItem("rekap_rows_per_page", e.target.value);
    renderRekapSiswa(1);
  };

  document.getElementById("pgPrev").onclick = () => renderRekapSiswa(currentPage - 1);
  document.getElementById("pgNext").onclick = () => renderRekapSiswa(currentPage + 1);

  document.getElementById("btnExportExcel").onclick = () => {
    if (!filteredData.length) return alert("Tidak ada data untuk diekspor");
    const worksheet = XLSX.utils.json_to_sheet(filteredData.map(d => ({
      "Nama Santri": d.santri,
      "Kelas": d.kelas,
      "Mapel": d.mapel,
      "KKM": d.kkm,
      "Rata UH": d.uh,
      "PTS": d.pts,
      "PAS Lisan": d.pasLisan,
      "PAS Tulis": d.pasTulis,
      "PAS Praktek": d.pasPraktek,
      "Nilai Akhir": d.na,
      "Status": d.status
    })));
    const workbook = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(workbook, worksheet, "Rekap");
    XLSX.writeFile(workbook, `Rekap_Nilai_${fKelas}_${fMapel}_${new Date().getTime()}.xlsx`);
  };
}


function labelType(type){
  if(type === 'PAS_LISAN') return 'PAS Lisan';
  if(type === 'PAS_TULIS') return 'PAS Tulis';
  if(type === 'PAS_PRAKTEK') return 'PAS Praktek';
  return type;
}


// Variabel Global untuk Pagination
function renderFilterBar() {
  const filterContainer = document.getElementById('transactionsFilter');
  if (!filterContainer) return;

  filterContainer.innerHTML = `
    <div style="display:flex; gap:8px; margin-bottom:12px; flex-wrap:wrap;">
      <input type="text" id="filterSearch" placeholder="Cari Nama Santri..." 
        style="padding:8px; border-radius:8px; border:1px solid #ccc; flex:1;">
      
      <select id="filterType" style="padding:8px; border-radius:8px; border:1px solid #ccc;">
        <option value="">Semua Tipe</option>
        <option value="UH">UH</option>
        <option value="PTS">PTS</option>
        <option value="PAS_LISAN">PAS Lisan</option>
        <option value="PAS_TULIS">PAS Tulis</option>
        <option value="PAS_PRAKTEK">PAS Praktek</option>
      </select>

      <button class="btn small delete-all" id="btnHapusSemua">Hapus Semua Data</button>
    </div>
  `;

  // Tambahkan event listener untuk pencarian otomatis
  document.getElementById('filterSearch').addEventListener('input', () => {
    renderTransactionsWith(window._latestTx || []);
  });

  document.getElementById('filterType').addEventListener('change', () => {
    renderTransactionsWith(window._latestTx || []);
  });

  // Logika Hapus Semua (Hanya Admin)
  document.getElementById('btnHapusSemua').onclick = async () => {
    if (confirm('PERINGATAN: Hapus SEMUA data nilai secara permanen?')) {
      const batch = writeBatch(db);
      const snap = await getDocs(nilaiCol);
      snap.forEach(d => batch.delete(d.ref));
      await batch.commit();
      alert('Semua data berhasil dihapus.');
    }
  };
}


// ====== DAFTAR GURU =====
async function renderGuruEditor() {
  if (userRole !== 'ADMIN') return;

  // 1. Persiapan Data Mapel untuk Dropdown
  const mapelOptionsRaw = mapelCache.length 
    ? mapelCache.map(m => `<option value="${escapeHtml(m.name)}">${escapeHtml(m.name)}</option>`).join('')
    : '<option value="">-- Isi Daftar Mapel Terlebih Dahulu --</option>';

  // 2. Render UI Utama
  mainPanel.innerHTML = `
    <h3>MANAJEMEN DAFTAR GURU</h3>

    <div style="background: #f1f5f9; padding: 15px; border-radius: 12px; margin-bottom: 20px; border: 1px dashed #cbd5e1;">
      <label style="font-weight:bold; color:var(--primary-dark);">Import Guru (Excel)</label>
      <input type="file" id="fileGuru" accept=".xlsx,.csv" style="display:block; margin: 10px 0;" />
      <div style="display:flex; gap:8px;">
        <button class="btn small" id="btnImportGuru">1. Baca File</button>
        <select id="sheetSelectorGuru" disabled style="flex:1;">
          <option value="">2. Pilih Sheet</option>
        </select>
      </div>
      <p style="font-size:11px; color:var(--muted); margin-top:8px;">Format Kolom: <b>Nama, NIP, Mapel</b></p>
    </div>

    <div class="card" style="padding:15px; border:1px solid #e2e8f0; margin-bottom:20px;">
      <label style="font-weight:bold;">Tambah Guru Secara Manual</label>
      <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-top:8px;">
        <input type="text" id="guruName" placeholder="Nama Lengkap" style="width:100%" />
        <input type="text" id="guruNip" placeholder="NIP/NIY (Wajib Unik)" style="width:100%" />
      </div>
      <select id="guruMapel" style="width:100%; margin:10px 0;">
        <option value="">-- Pilih Mapel Pengampu --</option>
        ${mapelOptionsRaw}
      </select>
      <button class="btn" id="btnAddGuru" style="width:100%">Tambah Guru</button>
    </div>

    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
      <button class="btn small delete-all" id="btnDeleteSelectedGuru">Hapus Terpilih</button>
      <span class="badge">${guruCache.length} Guru Terdaftar</span>
    </div>

    <div class="table-responsive">
      <table style="width:100%; background:#fff;">
        <thead>
          <tr>
            <th width="40"><input type="checkbox" id="checkAllGuru"></th>
            <th>Nama Guru</th>
            <th>NIP</th>
            <th>Mapel diampu</th>
            <th width="150">Aksi</th>
          </tr>
        </thead>
        <tbody id="guruTableBody">
          ${guruCache.map(g => `
            <tr id="row-${g.id}">
              <td><input type="checkbox" class="checkGuru" data-id="${g.id}"></td>
              <td class="cell-name"><b>${escapeHtml(g.name)}</b></td>
              <td class="cell-nip">${escapeHtml(g.nip || '-')}</td>
              <td class="cell-mapel">
                <span class="badge" style="background:var(--primary-soft); color:var(--primary-dark);">
                  ${escapeHtml(g.mapel || '-')}
                </span>
              </td>
              <td>
                <button class="btn small edit" onclick="window.enterEditModeGuru('${g.id}')">Edit</button>
                <button class="btn small delete" onclick="window.deleteGuru('${g.id}')">Hapus</button>
              </td>
            </tr>
          `).join('')}
        </tbody>
      </table>
    </div>
  `;

  // --- 3. EVENT LISTENERS ---

  // Tambah Guru Manual
  document.getElementById('btnAddGuru').onclick = async () => {
    const btn = document.getElementById('btnAddGuru');
    const name = document.getElementById('guruName').value.trim();
    const nip = document.getElementById('guruNip').value.trim();
    const mapel = document.getElementById('guruMapel').value;

    if (!name || !mapel || !nip) return alert("Nama, NIP, dan Mapel wajib diisi!");

    const isDuplicate = guruCache.some(g => String(g.nip) === String(nip));
    if (isDuplicate) return alert(`Gagal! Guru dengan NIP ${nip} sudah terdaftar.`);

    btn.disabled = true;
    btn.innerHTML = "Menyimpan...";

    try {
      await addDoc(guruCol, { 
        name, 
        nip, 
        mapel, 
        createdAt: serverTimestamp() 
      });
      alert("Guru berhasil ditambahkan!");
      if(typeof renderGuruEditor === "function") renderGuruEditor(); // Refresh UI
    } catch (e) {
      alert("Gagal menambah data.");
    } finally {
      btn.disabled = false;
      btn.innerHTML = "Tambah Guru";
    }
  };

  // Logika Import Excel
  let workbookGuru;
  document.getElementById('btnImportGuru').onclick = () => {
    const fileInput = document.getElementById('fileGuru');
    if (!fileInput.files[0]) return alert("Pilih file Excel dulu!");
    const reader = new FileReader();
    reader.onload = (e) => {
      const data = new Uint8Array(e.target.result);
      workbookGuru = XLSX.read(data, { type: 'array' });
      const selector = document.getElementById('sheetSelectorGuru');
      selector.innerHTML = '<option value="">-- Pilih Sheet --</option>' + 
        workbookGuru.SheetNames.map(s => `<option value="${s}">${s}</option>`).join('');
      selector.disabled = false;
      alert("File terbaca. Silakan pilih sheet.");
    };
    reader.readAsArrayBuffer(fileInput.files[0]);
  };

  document.getElementById('sheetSelectorGuru').onchange = async (e) => {
    const sheetName = e.target.value;
    if (!sheetName) return;
    
    const worksheet = workbookGuru.Sheets[sheetName];
    const jsonData = XLSX.utils.sheet_to_json(worksheet);
    
    if (jsonData.length === 0) return alert("Sheet kosong!");
    if (!confirm(`Import ${jsonData.length} data? NIP ganda otomatis diabaikan.`)) return;

    const batch = writeBatch(db);
    let importCount = 0;
    const existingNips = guruCache.map(g => String(g.nip));

    jsonData.forEach(row => {
      const rawNip = String(row.NIP || row.nip || '');
      const rawName = row.Nama || row.nama || '';
      const rawMapel = row.Mapel || row.mapel || '';
      
      if (rawNip && !existingNips.includes(rawNip)) {
        const newRef = doc(guruCol);
        batch.set(newRef, {
          name: rawName,
          nip: rawNip,
          mapel: rawMapel,
          createdAt: serverTimestamp()
        });
        existingNips.push(rawNip);
        importCount++;
      }
    });

    if (importCount > 0) {
      await batch.commit();
      alert(`Berhasil impor ${importCount} guru.`);
    } else {
      alert("Tidak ada data baru yang unik.");
    }
    renderGuruEditor();
  };

  // Checkbox & Bulk Delete
  document.getElementById('checkAllGuru').onclick = (e) => {
    document.querySelectorAll('.checkGuru').forEach(cb => cb.checked = e.target.checked);
  };

  document.getElementById('btnDeleteSelectedGuru').onclick = async () => {
    const selected = document.querySelectorAll('.checkGuru:checked');
    if (selected.length === 0) return alert("Pilih guru yang ingin dihapus.");
    if (confirm(`Hapus ${selected.length} guru terpilih?`)) {
      const batch = writeBatch(db);
      selected.forEach(cb => { batch.delete(doc(db, 'guru', cb.dataset.id)); });
      await batch.commit();
      alert("Data terpilih berhasil dihapus.");
      renderGuruEditor();
    }
  };
}

// --- 4. GLOBAL FUNCTIONS (Luar renderGuruEditor) ---

window.deleteGuru = async (id) => {
  if (!confirm("Hapus guru ini?")) return;
  try {
    await deleteDoc(doc(db, 'guru', id));
    alert("Terhapus!");
    // Panggil ulang render jika ada dalam scope global
  } catch (e) { alert("Gagal menghapus"); }
};

window.enterEditModeGuru = (id) => {
  const guru = guruCache.find(g => g.id === id);
  if (!guru) return;

  const row = document.getElementById(`row-${id}`);
  const mapelOptions = mapelCache.map(m => 
    `<option value="${m.name}" ${m.name === guru.mapel ? 'selected' : ''}>${m.name}</option>`
  ).join('');

  row.innerHTML = `
    <td colspan="2"><input type="text" id="edit-name-${id}" value="${escapeHtml(guru.name)}" style="width:100%"></td>
    <td><input type="text" id="edit-nip-${id}" value="${escapeHtml(guru.nip || '')}" style="width:100%"></td>
    <td><select id="edit-mapel-${id}" style="width:100%">${mapelOptions}</select></td>
    <td>
      <button class="btn small" onclick="window.saveEditGuru('${id}')">Simpan</button>
      <button class="btn small muted" onclick="renderGuruEditor()">Batal</button>
    </td>
  `;
};

window.saveEditGuru = async (id) => {
  const newName = document.getElementById(`edit-name-${id}`).value.trim();
  const newNip = document.getElementById(`edit-nip-${id}`).value.trim();
  const newMapel = document.getElementById(`edit-mapel-${id}`).value;

  if (!newName || !newNip) return alert("Nama dan NIP wajib diisi!");

  const isDuplicate = guruCache.some(g => String(g.nip) === String(newNip) && g.id !== id);
  if (isDuplicate) return alert(`NIP ${newNip} sudah digunakan oleh orang lain.`);

  try {
    await updateDoc(doc(db, 'guru', id), {
      name: newName,
      nip: newNip,
      mapel: newMapel,
      updatedAt: serverTimestamp()
    });
    alert("Berhasil diperbarui!");
    renderGuruEditor();
  } catch (e) { alert("Gagal memperbarui."); }
};
// Tambahkan ini di bagian bawah skrip modul Anda
window.renderGuruEditor = renderGuruEditor;


function showToast(title, message, type = 'success') {
  const container = document.getElementById('toast-container');
  const toast = document.createElement('div');
  toast.className = `toast ${type}`;
  
  toast.innerHTML = `
    <div class="toast-icon">${type === 'success' ? '‚úì' : '‚Ñπ'}</div>
    <div class="toast-content">
      <span class="toast-title">${title}</span>
      <span class="toast-msg">${message}</span>
    </div>
  `;
  
  container.appendChild(toast);

  // Trigger animasi masuk
  setTimeout(() => toast.classList.add('show'), 100);

  // Hapus otomatis setelah 4 detik
  setTimeout(() => {
    toast.classList.remove('show');
    setTimeout(() => toast.remove(), 500);
  }, 4000);
}

// Ekspos ke window agar bisa dipanggil di mana saja
window.showToast = showToast;



// ====== AUTH SISTEM PIN (VERSI PERBAIKAN) ======
function checkPin() {
    const userPin = prompt("Masukkan PIN Akses:");
    
    if (userPin === PIN_ADMIN) {
        isAuthorized = true;
        userRole = 'ADMIN';
        activeTab = 'DAFTAR_SANTRI'; // Admin langsung ke menu manajemen
        alert("Login berhasil sebagai ADMIN");
    } else if (userPin === PIN_USER) {
        isAuthorized = true;
        userRole = 'USER';
        activeTab = 'UH'; // User biasa langsung ke menu input
        alert("Login berhasil sebagai PENGINPUT");
    } else {
        alert("PIN Salah!");
        return; // Keluar jika salah
    }
    
    // Update tampilan setelah login sukses
    renderActiveTab();
}

function updateUIStatus() {
    userLabel.innerText = isAuthorized ? "Mode: Petugas" : "Offline";
    btnLogin.innerText = isAuthorized ? "Logout" : "Login (PIN)";
    // Tombol login berfungsi jadi logout kalau sudah masuk
    btnLogin.onclick = isAuthorized ? () => { isAuthorized = false; updateUIStatus(); renderActiveTab(); } : checkPin;
}


// Tambahkan ini di fungsi logout Anda
function logout() {
  isAuthorized = false;
  userRole = null;
  document.body.classList.remove('role-user'); // Menghapus mode user
  renderActiveTab();
}

// Tambahkan event ke tombol logout jika ada di HTML
if(btnLogout) {
  btnLogout.style.display = 'block'; // Munculkan tombol logout
  btnLogout.onclick = logout;
}


window.onbeforeunload = function() {
  if (document.querySelectorAll('.input-score').some(i => i.value !== "")) {
    return "Data belum disimpan, yakin ingin keluar?";
  }
};


window.editMapelKKM = async (id, mapelName, oldKKM) => {
  const newKKM = prompt(`Ubah KKM untuk ${mapelName}:`, oldKKM);
  
  if (newKKM === null || newKKM === "") return;
  const kkmNum = parseInt(newKKM);
  
  if (isNaN(kkmNum) || kkmNum < 0 || kkmNum > 100) {
    alert("KKM harus berupa angka antara 0 - 100");
    return;
  }

  // Konfirmasi perubahan massal
  if (!confirm(`Mengubah KKM ${mapelName} menjadi ${kkmNum} akan memperbarui semua warna status (Lulus/Remedial) pada tabel transaksi. Lanjutkan?`)) return;

  try {
    // 1. Update KKM di dokumen Mapel itu sendiri
    const mapelRef = doc(db, 'mapel', id);
    await updateDoc(mapelRef, { kkm: kkmNum });

    // 2. Cari & Update massal semua data NILAI yang memiliki mapel ini
    const q = query(collection(db, 'nilai'), where("mapel", "==", mapelName));
    const querySnapshot = await getDocs(q);
    
    if (!querySnapshot.empty) {
      const batch = writeBatch(db);
      querySnapshot.forEach((docSnap) => {
        batch.update(docSnap.ref, { kkm: kkmNum });
      });
      await batch.commit();
      alert(`Berhasil! KKM diperbarui dan ${querySnapshot.size} data transaksi telah disesuaikan.`);
    } else {
      alert(`KKM Mapel berhasil diubah.`);
    }
  } catch (error) {
    console.error("Error updating KKM massal:", error);
    alert("Terjadi kesalahan saat sinkronisasi data.");
  }
};

// Daftarkan aksi ke window agar bisa dipanggil onclick dari HTML
window.deleteGuru = async (id) => {
  if (!confirm("Hapus data guru ini?")) return;
  await deleteDoc(doc(db, 'guru', id));
};

window.editGuru = async (id, oldName) => {
  const newName = prompt("Ubah nama guru:", oldName);
  if (newName && newName !== oldName) {
    await updateDoc(doc(db, 'guru', id), { name: newName });
  }
};


/* --- DAFTARKAN FUNGSI KE GLOBAL AGAR BISA DIPANGGIL ONCLICK --- */

window.renderGuruEditor = renderGuruEditor;

window.enterEditModeGuru = (id) => {
  const guru = guruCache.find(g => g.id === id);
  if (!guru) return;

  const row = document.getElementById(`row-${id}`);
  const mapelOptions = mapelCache.map(m => 
    `<option value="${m.name}" ${m.name === guru.mapel ? 'selected' : ''}>${m.name}</option>`
  ).join('');

  row.innerHTML = `
    <td colspan="2"><input type="text" id="edit-name-${id}" value="${escapeHtml(guru.name)}" style="width:100%"></td>
    <td><input type="text" id="edit-nip-${id}" value="${escapeHtml(guru.nip || '')}" style="width:100%"></td>
    <td><select id="edit-mapel-${id}" style="width:100%">${mapelOptions}</select></td>
    <td>
      <button class="btn small" onclick="window.saveEditGuru('${id}')">Simpan</button>
      <button class="btn small ghost" onclick="window.renderGuruEditor()">Batal</button>
    </td>
  `;
};

window.saveEditGuru = async (id) => {
  // Ambil value dari input menggunakan ID unik yang dibuat di enterEditModeGuru
  const newName = document.getElementById(`edit-name-${id}`).value.trim();
  const newNip = document.getElementById(`edit-nip-${id}`).value.trim();
  const newMapel = document.getElementById(`edit-mapel-${id}`).value;

  if (!newName || !newNip) return alert("Nama dan NIP wajib diisi!");

  // Cek duplikasi NIP (kecuali untuk guru yang sedang diedit ini sendiri)
  const isDuplicate = guruCache.some(g => String(g.nip) === String(newNip) && g.id !== id);
  if (isDuplicate) return alert(`NIP ${newNip} sudah digunakan oleh orang lain.`);

  try {
    const guruRef = doc(db, 'guru', id);
    await updateDoc(guruRef, {
      name: newName,
      nip: newNip,
      mapel: newMapel,
      updatedAt: serverTimestamp()
    });
    alert("Berhasil diperbarui!");
    renderGuruEditor(); // Refresh tampilan tabel
  } catch (e) { 
    console.error(e);
    alert("Gagal memperbarui data."); 
  }
};


// Inisialisasi awal tombol login
btnLogin.onclick = checkPin;
btnLogout.style.display = 'none'; // Sembunyikan tombol logout bawaan lama
// initial render
renderActiveTab();
renderTransactionsWith(window._latestTx||[]);

</script>

</body>
</html>
